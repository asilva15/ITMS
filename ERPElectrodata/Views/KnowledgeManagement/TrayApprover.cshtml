@{
    ViewBag.Title = "TrayApprover";
    //Layout = null;
    //Layout = "~/Views/Shared/_LayoutKendo22.cshtml";
}

@*<link href="~/Content/fonts/font-awesome.min.css" rel="stylesheet" />*@
@*<script src="@Url.Content("~/Scripts/Itms/LeccionAprendida/TryApprover.js")" type="text/javascript"></script>*@
@*<script src="~/Scripts/Itms/LeccionAprendida/TryApprover.js"></script>*@
<link href="~/Content/sweet-alert.css" rel="stylesheet" />
<script src="~/Scripts/sweet-alert.js"></script>

<style>
    .loader {
        background-image: url(../../images/search_abs.gif);
        background-repeat: no-repeat;
        background-position: center;
        height: 100px;
    }
</style>

<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="page-title-icon">
                <i class="fa fa-user-check icon-gradient bg-sunny-morning"> </i>
            </div>
            <div>
                Aprobador de Lecciones Aprendidas
                <div class="page-title-subheading">

                </div>
            </div>
        </div>
    </div>
</div>

@(Html.Hidden("hdCuenta", (int)ViewBag.idCuenta))
    <div class="row">
        <div class="col-md-12">
            <div class="main-card mb-3 card element-block-example">
                <div class="card-body">
                    <div class="card-title">Buscar Lecciones Aprendidas</div>
                    <form class="">
                        <input type="hidden" id="idCalificacion" name="idCalificacion" readonly="readonly" />
                        <div class="form-row">
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="cbUnidadNegocio" for="cbUnidadNegocio" class="">Unidad de Negocio </label>
                                    <input id="Nivel1">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="cbMacroservicio" for="cbMacroservicio" class="">Macroservicio </label>
                                    <input id="Nvel2">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="cbServicio" for="cbServicio" class="">Servicio </label>
                                    <input id="Nivel3">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="cbIncidenteRequerimiento" for="cbIncidenteRequerimiento" class="">Incidente/Requerimiento </label>
                                    <input id="Nivel4">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="" for="cboBusquedatema" class="">Tema </label>
                                    <input id="cboBusquedatema">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="" for="cboBusquedaTipoTicket" class="">Tipo de Ticket </label>
                                    <input id="cboBusquedaTipoTicket">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="" for="dtFechaCreacionInicio" class="">Fecha Creación Inicio </label>
                                    <input id="dtFechaCreacionInicio">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="" for="dtFechaCreacionFin" class="">Fecha Creación Fin </label>
                                    <input id="dtFechaCreacionFin">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="" for="txtusquedaNroRevisiones" class="">Nro Revisiones </label>
                                    <input id="txtusquedaNroRevisiones" placeholder="Nro. Revisiones">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="" for="cboEstadoLeccionAprendida" class="">Estado </label>
                                    <input id="cboEstadoLeccionAprendida">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="position-relative form-group">
                                    <label id="" for="Nombre" class="">Puntuación </label>
                                    <div class="fg-line">
                                        <div>
                                            <div class="starrr stars">
                                                <a href="#" class="fa-star fa" style="font-size:20px"></a>
                                                <a href="#" class="fa-star fa" style="font-size:20px"></a>
                                                <a href="#" class="fa fa-star" style="font-size:20px"></a>
                                                <a href="#" class="fa fa-star" style="font-size:20px"></a>
                                                <a href="#" class="fa-star-o fa" style="font-size:20px"></a>
                                                <div class=""></div>
                                                Le otorgó <span class="stars-count">0</span> estrellas de calificación
                                            </div>
                                        </div>
                                        <script>
                                            //$(document).ready(function () {

                                            //    $(".stars").starrr();

                                            //    $('.stars-existing').starrr({
                                            //        rating: 4
                                            //    });

                                            //    $('.stars').on('starrr:change', function (e, value) {

                                            //        $('.stars-count').html(value);
                                            //        $('#idCalificacion').attr('value', value);
                                            //    });

                                            //    $('.stars-existing').on('starrr:change', function (e, value) {
                                            //        $('.stars-count-existing').html(value);
                                            //    });
                                            //});
                                        </script>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <br />
                                <button id="btnBuscar" type="button" class="mt-1 btn btn-primary btn-block block-element-btn-example-1"><i class="fa fa-search"></i> Buscar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


<div id="GridAprobador" class="contentView">
</div>

<div id="pagerAprobador" class="contentViewPager">
</div>
<div class="container-fluid">
        <div class="row">
            <div id="list"></div>
        </div>
    </div>

<div class="modal fade" id="myModal" data-backdrop="static" data-keyboard="false">
</div>

<script type="text/x-kendo-tmpl" id="tmpAprobador">
    <div id="id${IdLeccioNAprendida}" class="card-body py-3 btn-shadow btn-outline-focus">
        <div class="row no-gutters align-items-center">
            <div class="col-md-11">
                <a href="${Ruta}${IdLeccioNAprendida}" class="text-decoration-none" style="color:black" target="_blank">
                    <div class="card-body">
                     <div class="row no-gutters align-items-center">

                    <div class="col-md-1" style="width:6%; float:left; height:74px; min-width:60px; margin-left:10px;display:inline-block">
                        <div style="width:90%; margin:0 auto; height:100%; margin-top:14px;">
                            <div style="width: 50px; height: 42px; color: white; font-size: 2.2em;
                                    text-align: center; padding-top: 8px; background-color: ${ColorEstado};">
                                ${EstadoAprobacion}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3" style="text-align:center;display:inline-block">
                        <div class="small" id="idType${IdLeccioNAprendida}">${Titulo}</div>
                        <div class="small" id="idStat${IdLeccioNAprendida}">Estado: ${DescripcionEstadoAprobacion}</div>
                        <div class="small">Código: ${IdLeccioNAprendida}</div>
                    </div>
                    <div class="col-md-2" style="text-align:center;display:inline-block;">
                        <div class="small" id="idUR${IdLeccioNAprendida}">${Usuario}</div>
                        <div class="small">Solicitante</div>
                    </div>
                    <div class="col-md-1" style="text-align:center;display:inline-block;" id="idUA${IdLeccioNAprendida}">
                        <div class="small"><span>${Aprobador}%</span></div>
                        <div class="small">Aprueba </div>
                    </div>
                    <div class="col-md-2" style="text-align:center;display:inline-block;" id="idJusti${IdLeccioNAprendida}">
                        <div class="small">${DescripcionProblema}</div>
                    </div>
                    <div class="col-md-1" style="text-align:center;display:inline-block;" id="idMY${IdLeccioNAprendida}">
                        <div class="small"><span>${fechaCreacion}</span></div>
                        <div class="small">${fechaCreacion}</div>
                    </div>
                    <div class="col-md-1" style="text-align:center;display:inline-block;" id="idMY${IdLeccioNAprendida}">
                        <div class="small">Revisiones</div>
                        <div class="small" id="idAmount${IdLeccioNAprendida}">${NroRevisiones}</div>
                    </div>
                    </div>
            </div>
                </a>
            </div>
            <div class="col-md-1" style="display:inline-block">
                <div id="btnDetalle${IdLeccioNAprendida}" class="page-title-icon" onclick="onclickDetalle1(${IdLeccioNAprendida})" title="Ver Detalles"><i class="fa fa-comments fa-2x icon-gradient bg-sunny-morning"></i></div>
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">

    function onclickDetalle(IdLeccioNAprendida) {

        $("#myModal").empty();
        $("#myModal").modal("show");
        $.get('/KnowledgeManagement/_DetalleAprobador', { id: IdLeccioNAprendida }, function (html) {

            $("#myModal").html(html);
        })
    }

    function onclickDetalle1(IdLeccioNAprendida) {

        $("#lblTitulo").text("Módulo de Gestión del Conocimiento - Nuevo Temas");

        $("#btnDetalle" + IdLeccioNAprendida).attr("data-style", "expand-right");
        $("#btnDetalle" + IdLeccioNAprendida).attr("data-toggle", "modal");
        $("#btnDetalle" + IdLeccioNAprendida).attr("data-target", "#miModal");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load('/KnowledgeManagement/_DetalleAprobador/' + IdLeccioNAprendida);
    }

</script>

<script type="text/javascript">
    $(document).ready(function () {


        $("#txtusquedaNroRevisiones").kendoNumericTextBox({
            format: "#.#",
            decimals: 0,
            min: 0,
            value: 0
        });

        var leccionAprendida = {
            Nivel1: $("#Nivel1").val(),
            Nvel2: $("#Nvel2").val(),
            Nivel3: $("#Nivel3").val(),
            Nivel4: $("#Nivel4").val(),
            IdTema: $("#cboBusquedatema").val(),
            NroRevisiones: $("#txtusquedaNroRevisiones").val(),
            EstadoAprobacion: $("#cboEstadoLeccionAprendida").val(),
            Puntuacion: $("#idCalificacion").val(),
            FechaCreacionInicio: $("#dtFechaCreacionInicio").val(),
            FechaCreacionFin: $("#dtFechaCreacionFin").val(),
            TipoTicket: $("#cboBusquedaTipoTicket").val(),
        };
        var param = {
            objLessonLearned: leccionAprendida,
            palabraClave: $("#txtBusquedapalabraClave").val(),
        };

        $("#pagerAprobador").empty();
        $("#GridAprobador").empty();

        if ($("#GridAprobador").data("kendoListView")) {
            $("#pagerAprobador").data("kendoPager").destroy();
            $("#GridAprobador").data("kendoListView").destroy();
        }

        $.ajax({
            contentType: 'application/json; charset=utf-8',
            url: "/KnowledgeManagement/BuscarLeccionesAprendidas",
            data: JSON.stringify(param),
            datatype: "json",
            type: 'POST',
            cache: false,
            serverPaging: true,
            success: function (dataSource) {

                if (dataSource != undefined && dataSource.length > 0) {
                    $("#pagerAprobador").empty();
                    $("#GridAprobador").empty();

                    if ($("#GridAprobador").data("kendoListView")) {
                        $("#pagerAprobador").data("kendoPager").destroy();
                        $("#GridAprobador").data("kendoListView").destroy();
                    }

                    var dataSource = new kendo.data.DataSource({
                        data: dataSource,
                        pageSize: 15
                    }); 

                    $("#pagerAprobador").kendoPager({
                        dataSource: dataSource,
                        pageSizes: [15, 30, 65],
                        refresh: true
                    });

                    $("#GridAprobador").kendoListView({
                        dataSource: dataSource,
                        template: kendo.template($("#tmpAprobador").html())
                    });

                    swal.close();
                } /*else {
                                BusquedaFallida();
                            }*/
            },
            error: function () {
                BusquedaFallida();
            }
        });

    });

</script>
<script>
    $(document).ready(function () {

        $("#pagerAprobador").empty();
        $("#GridAprobador").empty();
        if ($("#GridAprobador").data("kendoListView")) {
            $("#pagerAprobador").data("kendoPager").destroy();
            $("#GridAprobador").data("kendoListView").destroy();
        }



        id = $('#hdCuenta').val();
        /*carga de Combos*/
        var Nivel1 = $("#Nivel1").kendoComboBox({
            autoBind: false,
            index: -1,
            dataTextField: "NAM_CATE",
            filter: "contains",
            dataValueField: "ID_CATE",
            dataBound: function (e) {

            },
            dataSource: {
                serverFiltering: false,
                schema: {
                    data: "Data",
                    total: "Count"
                },
                transport: {
                    read: "/Administrator/ListCategory?ID_ACCO=" + id + "&var=" + Math.random()
                }
            }
        }).data("kendoComboBox");
        var NivelAccion2 = $("#Nvel2").kendoComboBox({}).data("kendoComboBox");
        var NivelAccion3 = $("#Nivel3").kendoComboBox({}).data("kendoComboBox");
        var NivelAccion4 = $("#Nivel4").kendoComboBox({}).data("kendoComboBox");
        var IdTema = $("#cboBusquedatema").kendoComboBox({}).data("kendoComboBox");

        $("#cboBusquedaTipoTicket").kendoComboBox({
            autoBind: false,
            index: -1,
            dataTextField: "NAM_TYPE_TICK",
            filter: "contains",
            dataValueField: "ID_TYPE_TICK",
            dataSource: {
                data: [{ "ID_TYPE_TICK": "1", "NAM_TYPE_TICK": "INCIDENT" }, { "ID_TYPE_TICK": "2", "NAM_TYPE_TICK": "REQUEST" }, { "ID_TYPE_TICK": "3", "NAM_TYPE_TICK": "PROJECT" }, { "ID_TYPE_TICK": "4", "NAM_TYPE_TICK": "EVENT" }]
            }
        }).data("kendoComboBox");

        var estadoAprobacion_ = $("#cboEstadoLeccionAprendida").kendoComboBox({
            autoBind: false,
            index: -1,
            dataTextField: "EstadoAprobacion",
            filter: "contains",
            dataValueField: "IdEstadoAprobacion",
            dataSource: {
                data: [{ "IdEstadoAprobacion": "P", "EstadoAprobacion": "Pendiente" }, { "IdEstadoAprobacion": "A", "EstadoAprobacion": "Aprobado" }, { "IdEstadoAprobacion": "D", "EstadoAprobacion": "Desaprobado" }]
            }
        }).data("kendoComboBox");


        Nivel1.bind("change", function (e) {
            if (Nivel1.dataItem()) {
                $('#Nivel1').attr('value', Nivel1.dataItem().ID_CATE);
                cargarCombosAnidados(Nivel1.dataItem().ID_CATE, id);
                limpiarCategorias();
            }
            else {
                $('#Nivel1').attr('value', 0);
            }
        });


        function cargarCombosAnidados(idcatNivel1, id) {
            var Nvel2 = $("#Nvel2").kendoComboBox({
                autoBind: false,
                index: -1,
                dataTextField: "NAM_CATE",
                filter: "contains",
                dataValueField: "ID_CATE",
                dataSource: {
                    serverFiltering: false,
                    schema: {
                        data: "Data",
                        total: "Count"
                    },
                    transport: {
                        read: "/Administrator/ListCategoryLessonLearned?ID_ACCO=" + id + "&ID_CATE=" + idcatNivel1 + "&var=" + Math.random()
                    }
                }
            }).data("kendoComboBox");
            Nvel2.bind("change", function (e) {
                if (Nvel2.dataItem()) {
                    $('#Nvel2').attr('value', Nvel2.dataItem().ID_CATE);
                }
                else {
                    $('#Nvel2').attr('value', 0);
                }
            });

            var Nivel3 = $("#Nivel3").kendoComboBox({
                autoBind: false,
                index: -1,
                dataTextField: "NAM_CATE",
                filter: "contains",
                cascadeFrom: "Nvel2",
                dataValueField: "ID_CATE",
                dataSource: {
                    serverFiltering: true,
                    schema: {
                        data: "Data",
                        total: "Count"
                    },
                    transport: {
                        read: "/Administrator/ListCategory?ID_ACCO=" + id + "&var=" + Math.random()
                    }
                }
            }).data("kendoComboBox");
            Nivel3.bind("change", function (e) {
                if (Nivel3.dataItem()) {
                    $('#Nivel3').attr('value', Nivel3.dataItem().ID_CATE);
                    cargarTemas(id, Nivel3.dataItem().ID_CATE);
                }
                else {
                    $('#Nivel3').attr('value', 0);
                }
            });

            var Nivel4 = $("#Nivel4").kendoComboBox({
                autoBind: false,
                index: -1,
                dataTextField: "NAM_CATE",
                filter: "contains",
                cascadeFrom: "Nivel3",
                dataValueField: "ID_CATE",
                dataSource: {
                    serverFiltering: true,
                    schema: {
                        data: "Data",
                        total: "Count"
                    },
                    transport: {
                        read: "/Administrator/ListCategory?ID_ACCO=" + id + "&var=" + Math.random()
                    }
                }
            }).data("kendoComboBox");
            Nivel4.bind("change", function (e) {

                if (Nivel4.dataItem()) {
                    $('#Nivel4').attr('value', Nivel4.dataItem().ID_CATE);
                    cargarTemas(id, Nivel4.dataItem().ID_CATE);
                }
                else {
                    $('#Nivel4').attr('value', 0);
                }
            });
            /*Fin*/
        }


        function cargarTemas(id, idcatNivel1) {
            var IdTema = $("#cboBusquedatema").kendoComboBox({
                autoBind: false,
                index: -1,
                dataTextField: "Nomtema",
                filter: "contains",
                dataValueField: "IdTema",
                dataSource: {
                    serverFiltering: false,
                    schema: {
                        data: "Data",
                        total: "Count"
                    },
                    transport: {
                        read: "/KnowledgeManagement/ListTemaLessonLearned?ID_ACCO=" + id + "&ID_CATE=" + idcatNivel1
                    }
                }
            }).data("kendoComboBox");
        }

        var FechaCreacionInicio = $("#dtFechaCreacionInicio").kendoDateTimePicker().data("kendoDateTimePicker");
        var FechaCreacionFin = $("#dtFechaCreacionFin").kendoDateTimePicker().data("kendoDateTimePicker");

        function limpiarCategorias() {
            $("#Nvel2").data("kendoComboBox").value("");
            $("#Nivel3").data("kendoComboBox").value("");
            $("#Nivel4").data("kendoComboBox").value("");
        }


    });

    $("#btnBuscar").click(function () {
        listarLeccionesAprendidas();
    });

    function listarLeccionesAprendidas() {
        var leccionAprendidas = {
            Nivel1: $("#Nivel1").val(),
            Nvel2: $("#Nvel2").val(),
            Nivel3: $("#Nivel3").val(),
            Nivel4: $("#Nivel4").val(),
            IdTema: $("#cboBusquedatema").val(),
            NroRevisiones: $("#txtusquedaNroRevisiones").val(),
            EstadoAprobacion: $("#cboEstadoLeccionAprendida").val(),
            Puntuacion: $("#idCalificacion").val(),
            FechaCreacionInicio: $("#dtFechaCreacionInicio").val(),
            FechaCreacionFin: $("#dtFechaCreacionFin").val(),
            TipoTicket: $("#cboBusquedaTipoTicket").val(),
        };
        var param = {
            objLessonLearned: leccionAprendidas,
            palabraClave: $("#txtBusquedapalabraClave").val(),
        };

        $("#pagerAprobador").empty();
        $("#GridAprobador").empty();

        if ($("#GridAprobador").data("kendoListView")) {
            $("#pagerAprobador").data("kendoPager").destroy();
            $("#GridAprobador").data("kendoListView").destroy();
        }

        $.ajax({
            contentType: 'application/json; charset=utf-8',
            url: "/KnowledgeManagement/BuscarLeccionesAprendidas",
            data: JSON.stringify(param),
            datatype: "json",
            type: 'POST',
            cache: false,
            serverFiltering: true,
            serverPaging: true,
            beforeSend: function () {
                swal({ title: "Obteniendo resultados de su búsqueda, por favor espere.", text: "Bandeja de Lecciones Aprendidas", showConfirmButton: false, imageUrl: "../../images/search_abs.gif" })
            },
            success: function (dataSource) {

                if (dataSource != undefined && dataSource.length > 0) {
                    $("#pagerAprobador").empty();
                    $("#GridAprobador").empty();

                    if ($("#GridAprobador").data("kendoListView")) {
                        $("#pagerAprobador").data("kendoPager").destroy();
                        $("#GridAprobador").data("kendoListView").destroy();
                    }

                    var dataSource = new kendo.data.DataSource({
                        data: dataSource,
                        pageSize: 15
                    });

                    $("#pagerAprobador").kendoPager({
                        dataSource: dataSource,
                        pageSizes: [15, 30, 65],
                        refresh: true
                    });

                    $("#GridAprobador").kendoListView({
                        dataSource: dataSource,
                        template: kendo.template($("#tmpAprobador").html())
                    });
                    swal.close();
                } else {
                    BusquedaFallida();
                }
            },
            error: function () {
                BusquedaFallida();
            }
        });

    }


    function BusquedaFallida() {
        $("#pagerAprobador").empty();
        $("#GridAprobador").empty();
        swal("¡No se encontraron resultados para     su búsqueda!", "Bandeja de Temas", "info");
    }




    function mouseOverBandeja(id) {
        $("#id" + id).css("background-color", "#ffffff");
        $("#idType" + id).css("color", "#000000");
        $("#idStat" + id).css("color", "#000000");
        $("#idUR" + id).css("color", "#000000");
        $("#idUA" + id).css("color", "#000000");
        $("#idJusti" + id).css("color", "#000000");
        $("#idMY" + id).css("color", "#000000");
        $("#idAmount" + id).css("color", "#000000");
    }

    function mouseOutBandeja(id) {
        $("#id" + id).css("background-color", "#f5f5f5");
        $("#idType" + id).css("color", "#808080");
        $("#idStat" + id).css("color", "#808080");
        $("#idUR" + id).css("color", "#808080");
        $("#idUA" + id).css("color", "#808080");
        $("#idJusti" + id).css("color", "#808080");
        $("#idMY" + id).css("color", "#808080");
        $("#idAmount" + id).css("color", "#808080");
    }

    function PaymentRequest(id) {
        alert("El número de id es " + id);
    }
</script>
@model ERPElectrodata.Models.DETAILS_TICKET

@{
    ViewBag.Title = "Index";
    var impacto = ViewBag.Impacto;
    var garantiaProveedor = ViewBag.GarantiaProveedor;
    ViewBag.ID_CATE_MINSUR = ViewBag.ID_CATE_MINSUR ?? "0";
    Layout = "~/Views/Shared/_LayoutKendo22.cshtml";
}


<style>
    table.k-editor {
        height: auto !important;
    }

    .navVertical {
        margin: 0px;
        padding: 0px;
        list-style: none;
    }

        .navVertical ul {
            margin: 0px;
            padding: 0px;
            width: 100%;
            list-style: none;
        }

            .navVertical ul li {
                float: left;
                color: #022A41;
                font-size: 13px;
                margin: 0px;
                padding: 0px;
                border-bottom: 1px solid #e2e2e2;
                width: 100%;
            }

                .navVertical ul li a {
                    text-decoration: none;
                    color: #022A41;
                }

                    .navVertical ul li a div {
                        padding: 6px 10px 6px 10px;
                    }

                    .navVertical ul li a:hover div {
                        background-color: #022A41;
                        color: #e2e2e2;
                    }

    #navDT {
        width: 100%;
        list-style: none;
        margin: 0px;
        padding: 0px;
    }

        #navDT ul {
            margin: 0px;
            margin-top: 2px;
            /*border:solid 1px #e2e2e2;*/
            /*background-color:#e2e2e2;*/
            display: inline-block;
            list-style: none;
            padding: 0px;
            width: 100%;
            border-top: solid 1px #e2e2e2;
            /*border-bottom:solid 1px #e2e2e2;*/
        }

            #navDT ul li {
                float: left;
                color: #022A41;
                font-size: 13px;
                margin: 0px;
                padding: 0px;
            }

                #navDT ul li a {
                    text-decoration: none;
                    color: #022A41;
                }

                    #navDT ul li a div {
                        padding: 6px 10px 6px 10px;
                    }

                    #navDT ul li a:hover div {
                        background-color: #022A41;
                        color: #e2e2e2;
                    }

    .activeNavDT {
        background-color: #022A41;
        color: #e2e2e2;
    }

    .titulo a:hover {
        color: #2E64FE;
        cursor: pointer;
    }

    #tamGestionCambio {
        width: 78% !important;
    }

    .smallTitulo {
        opacity: .8;
        font-weight: bold;
    }

    .smallCampo {
        color: #444444;
        text-transform: capitalize;
    }


    .value-container {
        position: relative;
        font-family: "Poppins", sans-serif;
        font-size: 30px;
        color: #231c3d;
    }

    .btn-error {
        color: #fff;
        background-color: #d92550;
        border-color: #d92550;
    }

    .modal-form-container {
        border: solid;
        border-radius: 5px;
        border-color: #e2e2e2;
        padding: 5px;
    }

        .modal-form-container h2 {
            color: #333;
            text-align: center;
        }

        .modal-form-container label {
            font-size: 0.9em;
            color: #333;
            margin-bottom: 5px;
            display: block;
        }

        .modal-form-container input[type="email"],
        .modal-form-container input[type="text"],
        .modal-form-container textarea {
            width: 100%;
            padding: 10px;
            /*margin-bottom: 15px;*/
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 0.95em;
        }

            .modal-form-container input[type="email"]:focus,
            .modal-form-container input[type="text"]:focus,
            .modal-form-container textarea:focus {
                border-color: #007BFF;
                outline: none;
                box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
            }

        .modal-form-container textarea {
            resize: vertical;
        }

        .modal-form-container small {
            font-size: 0.8em;
            color: #666;
        }
</style>

<link href="~/Content/themes/plugin/iCheck/square/blue.css" rel="stylesheet" />
<script src="~/Content/themes/plugin/iCheck/icheck.js"></script>
<script src="~/Content/themes/plugin/toastr/toastr.min.js"></script>
<link href="~/Content/themes/plugin/toastr/toastr.min.css" rel="stylesheet" />
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
<link rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Public+Sans%3Awght%40400%3B500%3B700%3B900" />
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

<script>
    $(document).ready(function () {
        $('input').iCheck({
            checkboxClass: 'icheckbox_square-blue',
            radioClass: 'iradio_square-blue',
            increaseArea: '20%' // optional
        });
    });
</script>

<div class="row">
    <div class="col-md-7">
        <div class="main-card mb-3 card">
            <div class="card-header">
                <div style="flex: 25%">
                    @ViewBag.NAM_TYPE_TICK # @ViewBag.COD_TICK
                </div>
                <div style="flex: 50%">
                    <div style="padding-top:3px; padding-right:1%; float:right; width:73%; text-transform:capitalize; text-align:right;" id="divCIA"></div>
                </div>
                <div style="flex: 25%">
                    @if (ViewBag.BotonRegistroAtencion == 1)
                    {
                    <br />
                    <input onclick="RegistrarTiempoAtencion()" class="btn btn-gradient-success" style="font-weight:bold;margin-left:20px;" value="REGISTRAR ATENCIÓN">
                    <br /><br />
                    }
                </div>
            </div>
            <input type="hidden" id="idUsuario" name="idUsuario" readonly="readonly" />
            <div class="card-body">

                <div id="divDetaTicket">
                </div>

                <div id="divComentario">
                </div>

                <div class="card-body">
                    <ul class="tabs-animated-shadow nav-justified tabs-animated nav">
                        <li class="nav-item">
                            <a role="tab" class="nav-link active" id="tabActividad" data-toggle="tab" aria-selected="true">
                                <span class="nav-text"><i class="fa fa-comment"></i> Actividad</span>
                            </a>
                        </li>


                        <li class="nav-item">
                            <a role="tab" class="nav-link" id="tabActividadProgramar" data-toggle="tab" aria-selected="false">
                                <span class="nav-text"><i class="fa fa-calendar"></i> Programar o Poner en pausa</span>
                            </a>
                        </li>




                        @*
                        <li class="nav-item">
                            <a role="tab" class="nav-link" id="tabCambiarEstado" data-toggle="tab">
                                <span class="nav-text"><i class="fa fa-arrow-circle-up"></i> Cambiar Estado</span>
                            </a>
                        </li>*@

                        <li class="nav-item">
                            <a role="tab" class="nav-link" id="tabTransferir" data-toggle="tab">
                                <span class="nav-text"><i class="fa fa-fighter-jet"></i> Transferir</span>
                            </a>
                        </li>

                    </ul>
                    @using (Html.BeginForm("CreateEdata", "DetailsTicket", FormMethod.Post, new { enctype = "multipart/form-data", id = "FrmDetailIncident", target = "upload_target" }))
                    {
                    @Html.ValidationSummary(true)
                    <input type="hidden" value="@ViewBag.UploadFile" name="KEY_ATTA" id="KEY_ATTA" readonly="readonly" />
                    @*@Html.HiddenFor(model => model.ID_TICK)*@
                    <input id="ID_TICK" name="ID_TICK" value="@ViewBag.ID_TICK" hidden />

                    @Html.HiddenFor(model => model.ID_TYPE_DETA_TICK)
                    <div class="tab-content" id="DetalleTicketPrinc">
                        <div class="tab-pane active" id="tab-animated1-0" role="tabpanel">
                            <div class="form-row">
                                <div class="form-row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label id="" for="" class="">Desde </label>
                                            @Html.EditorFor(model => model.FROM_TIME)
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label id="" for="" class="">Hasta </label>
                                            @Html.EditorFor(model => model.TO_TIME)
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-12" id="DivEstado">

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label id="" for="" class="">Estado </label>

                                                @Html.EditorFor(model => model.ID_STAT, new { htmlAttributes = new { id = "ID_STAT" } })
                                                @Html.ValidationMessageFor(model => model.ID_STAT)
                                            </div>
                                        </div>
                                        <div class="col-md-4" id="divTipoResolucion" hidden>
                                            <div class="form-group">
                                                <label id="" for="" class="" style="padding-left:20px">Solución temporal</label>
                                                <div class="position-relative form-group">
                                                    <div>
                                                        <div class="custom-checkbox custom-control">
                                                            @Html.CheckBox("TipoResolucion", false)
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                        <div class="col-md-4" id="divBolsaHoras" hidden>

                                        </div>
                                    </div>

                                    <div class="modal-form-container" id="divFormularioEnvioCorreo" hidden>
                                        <div class="card-header">Enviar correo</div>
                                        @*<form id="correoForm" enctype="multipart/form-data">
                                            *@
                                            <input type="hidden" value="@ViewBag.IdTicket" name="IdTick" id="IdTick" readonly="readonly" />
                                            <label for="correos">Para:</label>
                                            <input type="email" id="correos" name="correos" placeholder="correo@ejemplo.com" multiple>
                                            <small id="cuerpoAyuda" style="color: #666;">* Para agregar varios correos electrónicos, sepárelos <b>únicamente con comas (,).</b> No utilice puntos y comas u otros separadores.</small>
                                            <br /> <br />
                                            <label for="cc">Con Copia (CC):</label>
                                            <input type="email" id="cc" name="cc" placeholder="correo@ejemplo.com" multiple>
                                            <small id="cuerpoAyuda" style="color: #666;">* Para agregar varios correos electrónicos, sepárelos <b>únicamente con comas (,).</b> No utilice puntos y comas u otros separadores.</small>
                                            <br /> <br />
                                            <label for="asunto">Asunto:</label>
                                            <input type="text" id="asunto" name="asunto" placeholder="Asunto del correo">
                                            <br /><br />
                                            <label for="cuerpo">Cuerpo del mensaje:</label>
                                            <textarea id="cuerpo" name="cuerpo" rows="6" placeholder="Escribe tu mensaje aquí...">Estimados,</textarea>
                                            <small id="cuerpoAyuda" style="color: #666;">* El texto no debe exceder los 2 MB <b>(aproximadamente 2,000,000 caracteres)</b> .</small>

                                            <br /><br />
                                            <label for="adjuntos">Adjuntar archivos:</label>
                                            <input type="file" id="adjuntosCorreo" name="files">
                                            <br />
                                            <button id="btnEnviarCorreo" type="submit" class="mb-2 mr-2 btn-pill btn btn-primary btn-block">Enviar</button>
                                            @*
                                        </form>*@

                                    </div>

                                </div>
                            </div>

                            <div class="form-row">

                                <div class="col-md-12" id="DivPonerEnPausa" hidden>
                                    <div class="form-group" style="text-align:center;">
                                        <br />
                                        <input type="radio" name="opcionesprogramar" value="programar" id="programar" style="margin: 0 20px;"> <label for="programar" style="margin-right: 40px;">Programar</label>
                                        <input type="radio" name="opcionesprogramar" value="pausa" id="pausa" style="margin: 0 20px;"> <label for="pausa" style="margin-right: 40px;">Poner en pausa</label>

                                    </div>
                                </div>



                            </div>
                            <br />

                            <div class="form-row">
                                @*<div class="col-md-4" id="divMotivoEspera" hidden>
                                    <div class="form-group">
                                        <label>Motivo de Espera </label>
                                        @Html.EditorFor(model => model.IdMotivoEstado)
                                    </div>
                                </div>*@
                                <div class="col-md-4" id="DivFechaProgramada" hidden>
                                    <div class="form-group">
                                        <label id="" for="" class="">Fecha Programada </label>
                                        @Html.EditorFor(model => model.FEC_SCHE)
                                        @Html.ValidationMessageFor(model => model.FEC_SCHE)
                                    </div>
                                </div>
                                <div class="col-md-4" id="divMotivoEsperaProgra" hidden>
                                    <div class="form-group">
                                        <label>Motivo de Espera </label>
                                        @Html.Editor("IdMotivoEstadoProgra")
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-md-4" id="DivArea" hidden>
                                    <div class="form-group">
                                        <label id="" for="" class="">Area Responsable </label>
                                        @Html.EditorFor(model => model.ID_QUEU)
                                        @Html.ValidationMessageFor(model => model.ID_QUEU)
                                    </div>
                                </div>
                                <div class="col-md-4" id="DivAsignado" hidden>
                                    <div class="form-group">
                                        <label id="" for="" class="">Asignado a </label>
                                        @Html.EditorFor(model => model.ID_PERS_ENTI)
                                        @Html.ValidationMessageFor(model => model.ID_PERS_ENTI)
                                    </div>
                                </div>


                            </div>

                            <div id="divComentarioyBotones">
                                <div class="form-row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label id="" for="" class="" style="padding-left:20px">Comentario </label>
                                            @Html.TextAreaFor(model => model.COM_DETA_TICK, new { rows = "20" })
                                            @Html.ValidationMessageFor(model => model.COM_DETA_TICK)

                                        </div>
                                    </div>


                                </div>
                                <br />


                                <div class="form-row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label id="" for="" class="">&nbsp; </label>
                                            <button type="button" data-toggle="modal" data-target="#miModal" onclick="AdjuntarComentario();" id="Adjuntar" class="mb-2 mr-2 btn-pill btn btn-success btn-block"><span>Adjuntar</span></button>

                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label id="" for="" class="">&nbsp; </label>


                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label id="" for="" class="">&nbsp; </label>


                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label id="" for="" class="">&nbsp; </label>
                                            <button id="submitDetail" type="button" class="mb-2 mr-2 btn-pill btn btn-primary btn-block"><span>Registrar</span></button>
                                            <button id="submit" class="mb-2 mr-2 btn-pill btn btn-primary btn-block" hidden><span>Crear</span></button>

                                        </div>
                                    </div>


                                </div>

                            </div>
                        </div>

                    </div>
                    <iframe id="upload_target" name="upload_target" src="" hidden></iframe>
                    }


                </div>
                <div id="divDetails"></div>
            </div>
        </div>
    </div>
    <div class="col-md-5">



        <div class="form-row">
            <div class="col-md-12">
                <div class="main-card mb-3 card">
                    <div class="card-header">
                        Gestión De Cambios
                    </div>
                    <div class="card-body" style="text-align:center">
                        <span id="MensajeCambio"></span>
                        <button id="btnGestionDeCambio" type="button" class="mb-2 mr-2 btn btn-gradient-info" onclick="GenerarCambio()" data-toggle="modal" data-target="#miModal">Generar Cambio</button>
                        <button id="btnIrCambio" type="button" class="mb-2 mr-2 btn btn-gradient-info" onclick="IrCambio(@ViewBag.IdCambio)">Ir al Cambio</button>
                        <button id="btnEntregaActivo" type="button" class="mb-2 mr-2 btn btn-gradient-info">Entrega de Activo</button>
                    </div>
                </div>
            </div>
        </div>




        <div class="form-row">
            <div class="col-md-12">
                <div class="main-card mb-3 card">
                    <div class="card-header">
                        Lecciones Aprendidas
                    </div>
                    <div class="card-body">
                        <div style="right:auto" class="col-md-12">
                            <div class="x_panel">
                                <div class="x_content lecciones">
                                    <ul class='list-unstyled msg_list' style='overflow-x: hidden; overflow-y: scroll;'></ul>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-row">
            <div class="col-md-12">
                <div class="main-card mb-3 card">
                    <div class="card-header">
                        Resumen de SLA
                    </div>
                    <div class="card-body">
                        <div style="right:auto" class="col-md-12">
                            <div class="x_panel">
                                <div class="x_content resumensla">
                                    <ul class='list-unstyled msg_list' style='overflow-x: hidden; overflow-y: scroll;'></ul>
                                </div>

                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>
        <div class="form-row">
            <div class="col-md-12">
                <div class="main-card mb-3 card">
                    <div class="card-header">
                        Plantillas de respuesta
                    </div>
                    <div class="card-body">
                        <div class="form-group row">
                            <div class="col-md-4" hidden>
                                <label id="" for="" class="" style="padding-left:20px">¿Ver en el Portal? </label>

                                <div>
                                    <div class="custom-checkbox custom-control">
                                        @Html.CheckBox("PortalComent", false)
                                        @Html.ValidationMessageFor(model => model.PortalComent)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4" id="DivCausa" hidden>
                                <div class="form-group">
                                    <label id="" for="" class="" style="padding-left:20px">Causas </label>
                                    <div class="position-relative form-group">
                                        <div>
                                            <div class="custom-checkbox custom-control">
                                                @Html.CheckBox("Causa", false)
                                                @Html.ValidationMessageFor(model => model.Causa)
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            <div class="col-md-4" id="DivEsperaCliente" hidden>
                                <div class="form-group">
                                    <label id="" for="" class="" style="padding-left:20px">¿Es Espera Por Cliente? </label>
                                    <div class="position-relative form-group">
                                        <div>
                                            <div class="custom-checkbox custom-control">
                                                @Html.CheckBox("EsperaPorCliente", false)
                                                @Html.ValidationMessageFor(model => model.EsperaPorCliente)
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-4" id="DivControlRemoto" hidden>
                                <div class="form-group">
                                    <label id="" for="" class="" style="padding-left:20px">Control Remoto </label>
                                    <div class="position-relative form-group">
                                        <div>
                                            <div class="custom-checkbox custom-control">
                                                @Html.CheckBox("ControlRemoto", false)
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>



                        </div>
                        <div class="col-md-12">
                            <div class="form-group row">
                                <div class="col-md-6">
                                    <label>Grupo</label>
                                    @*<label id="cboGrupo" for="ID_GRUPO" class="">Grupo</label>*@
                                    @Html.Editor("IDGRUPO")
                                </div>
                                <div class="col-md-6">
                                    <label>Plantilla</label>
                                    @*<label id="cboPlantilla" for="ID_PLAN" class="">Plantilla</label>*@
                                    @Html.Editor("IDPLAN")
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>
        <div class="form-row">
            <div class="col-md-12">
                <div class="main-card mb-3 card">
                    <div class="card-header">
                        Últimos tickets
                    </div>
                    <div class="card-body">
                        <div>
                            <div class="x_panel">
                                <div class="x_content ultimostickets">
                                    <ul class="list-unstyled msg_list" style="overflow-x: hidden; overflow-y: scroll;"></ul>
                                </div>
                            </div>
                        </div>
                        <div style="text-align:center;">
                            @if ((Convert.ToInt32(Session["OPERACIONES"]) == 1 || Convert.ToInt32(Session["SERVICEDESK"]) == 1 || Convert.ToInt32(Session["SUPERVISOR_SERVICEDESK"]) == 1 || Convert.ToInt32(Session["SUPERVISOR_OPERACIONES"]) == 1) && ViewBag.TieneSoporte == 1)
                            {
                            <button id="btnVerSoporte" onclick="verSoporteED()" class="mb-2 mr-2 btn btn-gradient-info" data-toggle="modal" data-target="#miModal">Ver Vigencia  </button>
                            }
                            <button id="btnTraza" onclick="detalleUsuario()" class="mb-2 mr-2 btn btn-gradient-info" data-toggle="modal" data-target="#miModal">Detalle Usuario</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <div class="form-row">
            <div class="col-md-12">
                <div class="main-card mb-3 card">
                    <div class="card-header">
                        Adjuntar
                    </div>
                    <div class="card-body">
                        <div id="divAttachFiles" style="padding:5px;height:185px;border:none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-row">
            <div class="col-md-12">
                <div class="main-card mb-3 card">
                    <div class="card-header">
                        Actividades
                    </div>
                    <div class="card-body">
                        <div id="divActivities">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<div id="divContent">
    <div style="float:left; width:60%;">

        <div class="bodyForm">

        </div>
    </div>

    @*<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="myModalLabel">Adjuntar Archivos</h4>
                </div>
                <div class="modal-body">
                    <div class="editor-label">
                        Type Document
                    </div>
                    <div class="editor-field">
                        @Html.TextBox("ArrayFile")
                    </div>
                    <br />
                    <input name="files" id="files" type="file" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="k-button" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>*@

    <div class="modal fade" id="EditCommentModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Cerrar</span></button>
                    <h4 class="modal-title" id="myModalLabel">Editar Descripción</h4>
                </div>
                <div id="divFrmLoadSummary">

                </div>

            </div>
        </div>
    </div>
    <div class="modal fade" id="modalGenerarCambio" role="dialog" aria-labelledby="modalGenerarCambioLabel" aria-hidden="true">
        <div class="modal-dialog" id="tamGestionCambio">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" id="cerrarAsig"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="modalGenerarCambioLabel">Gestión de Cambios</h4>
                </div>
                <div class="modal-body">
                    <div id="divGenerarCambio"></div>
                    <!-- CONTENIDO -->
                </div>
            </div>
        </div>
    </div>


</div>
<div class="modal fade" id="modalSoporteED" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" id="tamVerSoporte">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" IdRazon class="close" data-dismiss="modal" data-backdrop="false" id="cerrarAsig"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel"> <span id="tituloOP"></span></h4>
            </div>
            <div class="modal-body">
                <div id="divSoporteED"></div>
                <!-- CONTENIDO -->
            </div>
        </div>
    </div>
</div>
<script type="text/x-kendo-tmpl" id="templdu">
    <div class="du12">
        <div class="duCont">
            <div class="duContdet" style="text-transform:capitalize;margin:0px 5px 3px 5px;color:black;">
                Fotocheck: ${FOT_CLIE}<br>
                Usuario: ${NAM_CLIE}<br>
                <div style="float:left;padding:0px 5px 0px 0px">Tipo Usuario: </div><div style="color:${COLOR};"> ${USE_TYPE}</div>
                Cargo: ${JOB_TITL}<br>
                Area: ${ARE_CLIE}<br>
                Gestión: ${MANA}<br>
                Compañía: ${CIA}<br>
                Anexo: ${EXT}<br>
                Celular: ${CEL_CLIE}<br>
                RPM: ${RPM_CLIE}
            </div>
            <div class="duContFot">
            </div>
        </div>
    </div>
</script>

<script id="templateDownload" type="text/x-kendo-template">
    <tr data-uid="#= uid #">
        <td colspan="2">
            <a href="../../Adjuntos/#: NAM_ATTA #" target="_BLANK">#: NAM_ATTA #</a>
        </td>
        <td colspan="2">
            <strong>#: NAM_TYPE_DOCU_ATTA #</strong>
        </td>
    </tr>
</script>

<script>
    $(document).ready(function () {

        var editor = $("#COM_DETA_TICK").data('kendoEditor');
        if (editor) {
            editor.value(''); // Set the editor's content to an empty string
        }

        function toggleImpactoServicioVisibility() {
            var estadoValue = $('#ID_STAT').val(); // Obtener el valor actual del campo Estado
            // Mostrar el campo de Impacto del Servicio si el estado es igual a 4, ocultarlo en otro caso
            if (estadoValue == '4') {
                $('#impactoServicioContainer').show(); // Mostrar el contenedor
            } else {
                $('#impactoServicioContainer').hide(); // Ocultar el contenedor
            }
        }

        // Llamar a la función al cargar la página para inicializar el estado del campo
        toggleImpactoServicioVisibility();

        // Llamar a la función cada vez que cambie el valor del campo Estado
        $('#ID_STAT').change(function () {
            toggleImpactoServicioVisibility();
        });

        $("#ImpactoServicio").kendoComboBox({

            autoBind: true,

            dataTextField: "text",

            dataValueField: "value",

            dataSource: [

                { text: "Seleccionar", value: "" },

                { text: "Si", value: "Si" },

                { text: "No", value: "No" }

            ],

            value: "@ViewBag.Impacto"

        }).data("kendoComboBox");

        // adjuntos correo
        const maxFileSize = 4 * 1024 * 1024; // 4 MB en bytes
        const maxFiles = 3; // Límite de archivos permitidos
        let archivosSubidos = []; // Lista para almacenar archivos seleccionados

        const extensionesPermitidas = [
            'xlsx', 'xls', 'xlsm', 'ods', 'docx', 'docm', 'doc', 'csv', 'pdf', 'txt', 'gif', 'jpg', 'jpeg', 'png', 'tif', 'tiff',
            'rtf', 'bmp', 'cgm', 'css', 'shtml', 'html', 'htm', 'zip', 'xml', 'ppt', 'pptx', 'tar', 'ez', 'ics', 'mobi', 'msg',
            'pub', 'eps', 'odt', 'mp3', 'm4a', 'm4v', 'wma', 'ogg', 'flac', 'wav', 'aif', 'aifc', 'aiff', 'mp4', 'mov', 'avi',
            'mkv', 'mpeg', 'mpg', 'wmv', 'pkpass'
        ];

        $("#adjuntosCorreo").kendoUpload({
            localization: {
                select: "Adjuntar Documentos"
            },
            select: function (e) {
                const totalFiles = archivosSubidos.length + e.files.length;

                // Validar límite de archivos
                if (totalFiles > maxFiles) {
                    e.preventDefault();
                    toastr.warning(`Solo se pueden adjuntar un máximo de ${maxFiles} archivos.`);
                    return;
                }

                $.each(e.files, function (index, file) {
                    const extensionArchivo = file.extension.replace('.', '').toLowerCase();

                    // Validar tipo de archivo
                    if (!extensionesPermitidas.includes(extensionArchivo)) {
                        e.preventDefault();
                        toastr.error(`El archivo "${file.name}" tiene una extensión no permitida. Archivos permitidos: ${extensionesPermitidas.join(', ')}.`);
                        return;
                    }

                    // Verificar el tamaño de cada archivo
                    if (file.size > maxFileSize) {
                        e.preventDefault();
                        toastr.error(`El archivo "${file.name}" supera el tamaño máximo de 4 MB y no será subido.`);
                    } else {
                        archivosSubidos.push(file.rawFile); // Agregar archivos válidos
                    }
                });
            },
            remove: function (e) {
                // Eliminar archivos individuales de la lista local
                e.files.forEach(fileToRemove => {
                    archivosSubidos = archivosSubidos.filter(
                        file => file.name !== fileToRemove.name
                    );
                });

                // Mostrar la cantidad actualizada de archivos
                console.log(`Archivos restantes: ${archivosSubidos.length}`);
            }
        });


        // Interceptar envío del formulario
        $("#FrmDetailIncident").on("submit", function (e) {
            e.preventDefault(); // Prevenir envío normal del formulario

            const button = document.querySelector('#btnEnviarCorreo');
            button.disabled = true;

            const buttondetalle = document.querySelector('#submitDetail');
            buttondetalle.disabled = true;

            const formData = new FormData(this); // Crear objeto FormData del formulario

            const cuerpoHtml = $('#cuerpo').val().replace(/\n/g, '<br>'); // Reemplazar saltos de línea con <br>
            formData.set('cuerpo', cuerpoHtml); // Actualizar el valor del textarea con el contenido procesado

            // Añadir los archivos subidos al FormData
            archivosSubidos.forEach(file => {
                formData.append("archivosSubidos", file);
            });

            // Enviar el FormData al servidor con AJAX
            $.ajax({
                url: this.action,
                method: this.method,
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function () {
                    var cbEstado = $("#ID_STAT").val(); // Obtiene el valor del estado
                    //var isTipoResolucionChecked = $('input[name="TipoResolucion"]').is(':checked'); // Verifica si el checkbox está marcado

                    if (cbEstado == 4) {
                        // Solo muestra el toast si NO es una solución temporal
                        toastr.info("Enviando correo, por favor espere...");
                    }

                },
                success: function (response) {
                    console.log(response);
                    // Extraer los argumentos de uploadDone del string
                    const match = response.match(/uploadDone\(([^)]+)\)/);
                    if (match && match[1]) {
                        // Convertir los argumentos en un array
                        const args = match[1]
                            .match(/(?:'[^']*'|"[^"]*"|[^,]+)+/g) // Divide por comas, respetando las comillas
                            .map(arg => arg.trim().replace(/^['"]|['"]$/g, ""));

                        // Llamar a uploadDone con los argumentos extraídos
                        if (typeof top.uploadDone === "function") {
                            top.uploadDone(...args);
                        } else {

                            button.disabled = false;
                            buttondetalle.disabled = false;
                            toastr.error("La función uploadDone no está disponible.");
                        }
                    } else {
                        button.disabled = false;
                        buttondetalle.disabled = false;
                        toastr.error("No se pudo procesar la respuesta del servidor.");
                    }
                },
                error: function () {
                    button.disabled = false;
                    buttondetalle.disabled = false;
                    toastr.error("Hubo un error al enviar los archivos.");
                }
            });



        });

        LimpiarValoresEdata();
    });

</script>


<script type="text/javascript">


    $("#tabActividad").click(function () {
        LimpiarValoresEdata();
        $("#tabActividad").addClass("active");
        $("#tabActividadProgramar").removeClass("active");
        $("#tabCambiarEstado").removeClass("active");
        $("#tabTransferir").removeClass("active");

        //$("#DivCausa").attr("hidden", true);
        /*$("#DivCausa").removeAttr("hidden");*/
        $("#DivCausa").attr("hidden", true);
        $("#DivFechaProgramada").attr("hidden", true);
        $("#DivEsperaCliente").attr("hidden", true);
        $("#DivEstado").removeAttr("hidden");
        $("#DivArea").attr("hidden", true);
        $("#DivAsignado").attr("hidden", true);
        $("#DivFechaFinReal").attr("hidden", true);
        $("#DivControlRemoto").attr("hidden", true);
        /*  $("#divMotivoEspera").attr("hidden", true);*/
        $("#divMotivoEsperaProgra").attr("hidden", true);
        $("#ID_TYPE_DETA_TICK").val(1);
        $("#FEC_END_REAL").val('');
        if (@ViewBag.TicketProyecto == 1) {
        $("#subcategorizacionPry").attr("hidden", false);
        $("#divCtrlRemot").attr("hidden", false);
    } else {
        $("#subcategorizacionPry").attr("hidden", true);
        $("#divCtrlRemot").attr("hidden", true);

    }
    // Ocultar FROM_TIME y TO_TIME
    $("input[name='FROM_TIME']").parent().parent().attr("hidden", false);
    $("input[name='TO_TIME']").parent().parent().attr("hidden", false);
    $("#divTipoResolucion").attr("hidden", true);
    $("#divFormularioEnvioCorreo").attr("hidden", true);
    $("#divComentarioyBotones").attr("hidden", false);


    $("#divRazon").attr("hidden", true);
    $("#DivPonerEnPausa").attr("hidden", true);
    $("#divBolsaHoras").attr("hidden", true);
    $("#divRazon").removeAttr("hidden");

    });

    // Cuando se hace clic en el tab "tabActividadProgramar"
    $("#tabActividadProgramar").click(function () {
        LimpiarValoresEdata(); // Asumo que esta función ya está definida
        $("#tabActividad").removeClass("active");
        $("#tabActividadProgramar").addClass("active");
        $("#tabCambiarEstado").removeClass("active");
        $("#tabTransferir").removeClass("active");

        // Mostrar los campos necesarios
        $("#DivPonerEnPausa").removeAttr("hidden");
        $("#DivCausa").attr("hidden", true);
        /*$("#DivFechaProgramada").removeAttr("hidden");*/
        /* $("#DivEsperaCliente").removeAttr("hidden");*/
        $("#DivEsperaCliente").attr("hidden", true);
        /*$("#divMotivoEspera").attr("hidden", true);*/
        $("#DivEstado").attr("hidden", true);
        $("#DivArea").attr("hidden", true);
        $("#DivAsignado").attr("hidden", true);
        $("#DivFechaFinReal").attr("hidden", true);
        $("#DivControlRemoto").attr("hidden", true);
        $("#ID_TYPE_DETA_TICK").val(3);
        $("#ID_STAT").val(5);
        $("#subcategorizacionPry").attr("hidden", true);
        $("#divCtrlRemot").attr("hidden", true);
        $("#divTipoResolucion").attr("hidden", true);
        $("#divFormularioEnvioCorreo").attr("hidden", true);
        $("#divComentarioyBotones").attr("hidden", false);
        $("#divRazon").attr("hidden", true);

        // Ocultar FROM_TIME y TO_TIME
        $("input[name='FROM_TIME']").parent().parent().attr("hidden", true);
        $("input[name='TO_TIME']").parent().parent().attr("hidden", true);
    });

    // Listener para los radios "programar" y "pausa"
    $('input[name="opcionesprogramar"]').on('ifChecked', function (event) {
        if ($(this).val() === 'pausa') {
            // Mostrar los divs relacionados con "Poner en pausa"
            $("#divMotivoEsperaProgra").removeAttr("hidden");
            $("#DivFechaProgramada").attr("hidden", true); // Ocultar Programación
        } else if ($(this).val() === 'programar') {
            // Mostrar los divs relacionados con "Programar"
            $("#DivFechaProgramada").removeAttr("hidden");
            $("#divMotivoEsperaProgra").removeAttr("hidden");
        }
    });

    //$("#tabCambiarEstado").click(function () {

    //});

    $("#tabTransferir").click(function () {
        LimpiarValoresEdata();
        $("#tabActividad").removeClass("active");
        $("#tabActividadProgramar").removeClass("active");
        $("#tabCambiarEstado").removeClass("active");
        $("#tabTransferir").addClass("active");
        $("#DivPonerEnPausa").attr("hidden", true);

        $("#DivArea").removeAttr("hidden");
        $("#DivAsignado").removeAttr("hidden");
        $("#DivCausa").attr("hidden", true);
        $("#DivFechaProgramada").attr("hidden", true);
        $("#DivEsperaCliente").attr("hidden", true);
        $("#DivEstado").attr("hidden", true);
        $("#DivFechaFinReal").attr("hidden", true);
        $("#DivControlRemoto").attr("hidden", true);
        /*$("#divMotivoEspera").attr("hidden", true);*/
        $("#divMotivoEsperaProgra").attr("hidden", true);
        $("#divBolsaHoras").attr("hidden", true);
        $("#ID_TYPE_DETA_TICK").val(2);
        $("#subcategorizacionPry").attr("hidden", true);
        $("#divCtrlRemot").attr("hidden", true);
        $("#divTipoResolucion").attr("hidden", true);
        $("#divFormularioEnvioCorreo").attr("hidden", true);
        $("#divComentarioyBotones").attr("hidden", false);
        $("#divRazon").attr("hidden", true);
        // Ocultar FROM_TIME y TO_TIME
        $("input[name='FROM_TIME']").parent().parent().attr("hidden", true);
        $("input[name='TO_TIME']").parent().parent().attr("hidden", true);
    });

    // bolsa de horas
    function ObtenerBolsaHoras(id) {
        $("#divBolsaHoras").empty();

        $.ajax({
            url: "/SoporteED/ObtenerDetalleBolsaHoras/",
            data: "&IdTick=" + id,
            cache: false,
            type: "GET",
            dataType: "json",
            success: function (data) {
                strPrioridad = '';
                $.each(data['Data'], function (index) {

                    if ((data['Data'][index]) == 'SI') {
                        strPrioridad =

                            '<div class="form-group">' +

                            '<label style="padding-left:20px">¿Efectivo para consumo de horas?:</label>' +

                            '<div class="position-relative form-group row">' +

                            '<div class="col-md-2 custom-checkbox custom-control" >' +
                            '<input id="AplicaConsumoHoras" name="AplicaConsumoHoras" type="checkbox" />' +
                            '</div>' +
                            '<div class="col-md-10" id="minutosEfectivosContainer" style="visibility:hidden;">' +
                            '<input type="number" id="MinutosEfectivos" name="MinutosEfectivos" style="width:60%"/> Min' +
                            '</div>' +
                            '</div>' +

                            '</div>';
                    }

                });

                $("#divBolsaHoras").append(strPrioridad);

                // Agrega el evento change al checkbox
                $("#AplicaConsumoHoras").change(function () {
                    if ($(this).is(":checked")) {
                        $("#minutosEfectivosContainer").css("visibility", "visible");
                    } else {
                        $("#minutosEfectivosContainer").css("visibility", "hidden");
                    }
                });
            }
        });
    }

    function LimpiarValoresEdata() {

        $("#ID_STAT").data("kendoComboBox").value("");


        $("#Causa").iCheck("uncheck");
        $("#FEC_SCHE").data("kendoDateTimePicker").value("");
        $("#EsperaPorCliente").iCheck("uncheck");
        $("#ID_QUEU").data("kendoComboBox").value("");
        $("#ID_PERS_ENTI").data("kendoComboBox").value("");
        /*$("#IdMotivoEstado").data("kendoComboBox").value("");*/
        $("#IdMotivoEstadoProgra").data("kendoComboBox").value("");
        $('input[name="opcionesprogramar"]').iCheck('uncheck');
        // Limpiar datos del formulario de envío de correo

        $("#correos").val(""); // Limpiar campo 'Para'
        $("#cc").val(""); // Limpiar campo 'CC'
        $("#asunto").val(""); // Limpiar el asunto
        $("#cuerpo").val("Estimados,"); // Restablecer el cuerpo del mensaje
        //$("#adjuntosCorreo").val(""); // Limpiar los archivos adjuntos


    }

    function a_entero(valor) {
        //intento convertir a entero.
        //si era un entero no le afecta, si no lo era lo intenta convertir
        valor = parseInt(valor);
        //comprobamos si es un valor entero
        if (isNaN(valor)) {
            //no es entero 0
            return 0;
        } else {
            //es un valor entero
            return valor;
        }
    }

    function closeWinModalPopUpLoad(sw) {

        $("#dlgl").hide('200', "swing", function () {
            $("#bkgl").fadeOut("300");
        });
    }

    function winPopUpModalLoad(title, contHtml, ancho, alto) {

        var altobkg = 0;
        var top = 0;
        altpan = $(window).height(); // devuelve la altura del viewport del navegador
        altobkg = $(document).height(); // devuelve la altura del documento HTML
        altbar = $(window).scrollTop(); // devuelve la posición vertical actual de la barra de scroll
        top = altbar + (altpan / 2);
        $("#winPopUpModalLoad").prepend("<div id='bkgl' class='backgroundcad' style='z-index: 998; display: visibility; height: " + altobkg + "px;'>" +
            "<div id='dlgl' class='modalcad' style='z-index: 998; display: none; top: " + a_entero(top) + "px; width: " + a_entero(ancho) + "px; margin-left: -" + a_entero(ancho) / 2 + "px; height: " + a_entero(alto) + "px; margin-top: -" + a_entero(alto) / 2 + "px;'>" +
            "<div id='titulomodall' class='titlemodalcad'>" +
            "</div><div id='contenidomodall' class='contenidomodalcad'></div>" +
            "<div class='divLoading'></div>" +
            "</div></div>");

        if ($('#bkgl').css("visibility") == 'hidden') {
            document.getElementById('bkgl').style.visibility = '';
            $("#bkgl").hide();
        }
        if ($('#bkgl').css("visibility") == 'hidden') {
            document.getElementById('dlgl').style.visibility = '';
            $("#dlgl").hide();
        }
        $("#bkgl").fadeIn(300, "linear", function () {
            $("#dlgl").show(200, "swing");
            $("#titulomodall").prepend(title)
            $("#contenidomodall").prepend('<div style="text-align:justify">' + contHtml + '</div>')
        });
        $("#closebtnmodall").click(function () {
            $("#dlgl").hide('200', "swing", function () {
                $("#bkgl").fadeOut("300");
            });
        });
    }
    /*################################################################## GCR161203 #######################################################################################*/

    function aprobarAcceso() {

        var idTick = @ViewBag.ID_TICK;
        $("#lblTitulo").text("Aprobar Acceso");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load("/Ticket/viewAprobarAcceso?id=" + idTick + "&var=" + Math.random());
    }
    function rechazarAcceso() {

        var idTick = @ViewBag.ID_TICK;
        $("#lblTitulo").text("Rechazar Acceso");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load("/Ticket/viewRechazarAcceso?id=" + idTick + "&var=" + Math.random());
    }
    function masInformacionAcceso() {

        var idTick = @ViewBag.ID_TICK;
        $("#lblTitulo").text("Solicitar Más Información Sobre el Acceso");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load("/Ticket/viewMasInformacionAcceso?id=" + idTick + "&var=" + Math.random());
    }

    function crearTicketRemediacionHost() {

        var idTick = @ViewBag.ID_TICK;
        $("#lblTitulo").text("Solicitar Remediación de Host");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load("/Ticket/viewGenerarTicketRemediacionHostBuenaventura?id=" + idTick + "&var=" + Math.random());
    }

    function aprobarAccesoGTI() {

        var idTick = @ViewBag.ID_TICK;
        $("#lblTitulo").text("Solicitar Aprobación de GTI");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load("/Ticket/viewAprobarAccesoGTI?id=" + idTick + "&var=" + Math.random());
    }


    function detalleUsuario() {

        var idUsuario = $("#idUsuario").val();
        $("#lblTitulo").text("Detalle de Usuario");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load("/Ticket/viewDetalleUsuario?id=" + idUsuario + "&var=" + Math.random());

        //var htmlForm = '<div id="FormDetalleUsuario"></div>';
        //winFormPopUpModal("Detalle de Usuario", htmlForm, 850, 600);
        //$("#FormDetalleUsuario").load("/Ticket/viewDetalleUsuario?id=" + idUsuario + "&var=" + Math.random());
    }
    function detalleTicketPadreHijo() {
        $("#lblTitulo").text("Ticket Padre-Hijo");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load("/Ticket/verTicketPadreHijo?id=" + @ViewBag.ID_TICK + "&var=" + Math.random());

        @*var htmlForm = '<div id="FormDetalleTicketPadreHijo"></div>';
        winFormPopUpModal("Ticket Padre-Hijo", htmlForm, 580, 320);
        $("#FormDetalleTicketPadreHijo").load("/Ticket/verTicketPadreHijo?id=" + @ViewBag.ID_TICK + "&var=" + Math.random());*@
    }
    /*################################################################## GCR161203 #######################################################################################*/
    function verSoporteED() {
        $("#lblTitulo").text("Lista de Soportes");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load("/SoporteED/ListaSoportes/@ViewBag.IdDocuSale");

        @* $("#divSoporteED").empty();
        $("#divSoporteED").load("/SoporteED/ListaSoportes/@ViewBag.IdDocuSale");
        $('#tituloOP').text('Lista de Soportes');*@
    }
    var i_conf = 0;
    //
    $(document).ready(function () {

        $("#submitDetail").on("click", function () {

            $("#submit").click();

        });
        if (@ViewBag.TicketProyecto == 1) {
        $("#subcategorizacionPry").attr("hidden", false);
        $("#divCtrlRemot").attr("hidden", false);
    } else {
        $("#subcategorizacionPry").attr("hidden", true);
        $("#divCtrlRemot").attr("hidden", true);
    }
    if (@ViewBag.AplicaCambio== 1) {
        var flag = 0;
        $("#btnEntregaActivo").click(function () {
            window.open("/DeliveryReception/Create/@ViewBag.ID_TICK", "_blank");
            //   messg = "Mostrar botón Entrega Activo";
        });
        if (((@ViewBag.Estado == 1 || @ViewBag.Estado == 3 || @ViewBag.Estado == 5 ) && @ViewBag.AplicaGestionActivo == 0) || @ViewBag.Estado == 2 || @ViewBag.Estado == 4 || @ViewBag.Estado == 6 ) {
            $("#btnEntregaActivo").hide();


        }
        if ( @ViewBag.Estado == 2 || @ViewBag.Estado == 4  ) {
            $("#ListaTarea").hide();
            $("#MensajeTarea").text("No se encontraron tareas pendientes.")

        }
        if ((@ViewBag.Estado == 2 || @ViewBag.Estado == 4) && (@ViewBag.ID_CATE_MINSUR == 27158 || @ViewBag.ID_CATE_MINSUR == 28529 || @ViewBag.ID_CATE_MINSUR == 29900 || @ViewBag.ID_CATE_MINSUR == 32465 || @ViewBag.ID_CATE_MINSUR == 32466)) {
            $("#btnImportarTMovil").hide();
        }
        if ( @ViewBag.Estado== 4 ||  @ViewBag.Estado== 6 ||  @ViewBag.IdCambio!= 0) {
            $("#btnGestionDeCambio").hide();
            flag = 1;
            //  mssgCR = "btnGestionDeCambio 1 - Ocultar";
        }

        if (@ViewBag.IdCambio== 0) {
            $("#btnIrCambio").hide();
            flag = flag + 1;
        }
        if (flag == 2) {
            $("#MensajeCambio").text("No se encontró una solicitud de cambios.")

        }
    }else {
        $("#btnGestionDeCambio").hide();
        $("#btnIrCambio").hide();
        $("#MensajeCambio").text("La solicitud del cambio solo aplica a los tickets de tipo incidente o requerimiento.");
        //mssgCR = "btnGestionDeCambio 2 - Ocultar";

    }

    if (@ViewBag.ExisteCambio == 0) {
        $("#linkUS").show();
        $("#btnIrCambio").hide();
    }
        else {
        $("#linkUS").hide();
        $("#btnIrCambio").show();
        //$("#btnEntregaActivo").hide();
        //MARCA -------------------------------------------------------------------------------------
        $("#btnGestionDeCambio").hide();
        // mssgCR = "btnGestionDeCambio 3 - Ocultar";

    }
    if (@ViewBag.ExisteCambioInc == 1) {
        $("#linkUS").hide();
        $("#btnIrCambio").show();
        //$("#btnEntregaActivo").hide();
        $("#btnGestionDeCambio").hide();
        // mssgCR = "btnGestionDeCambio 4 - Ocultar";

    }

    if (((@ViewBag.Estado == 1 || @ViewBag.Estado == 3 || @ViewBag.Estado == 5 ) && @ViewBag.AplicaGestionActivo == 0) || @ViewBag.Estado == 2 || @ViewBag.Estado == 4 || @ViewBag.Estado == 6 ) {
        $("#btnEntregaActivo").hide();
    }else {
        $("#btnGestionDeCambio").hide();
        // mssgCR = "btnGestionDeCambio 5 - Ocultar";

    }


    var IdMotivoEstadoProgra = $("#IdMotivoEstadoProgra").kendoComboBox({
        dataTextField: "NombreMotivo",
        dataValueField: "Id",
        filter: "contains",
        autoBind: true,
        dataSource: {
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {
                read: "/Ticket/ListaMotivoEspera/1?var=" + Math.random()
            }
        }
    }).data("kendoComboBox");

    $("#ID_TYPE_DETA_TICK").val(1);

    $("#AMM_SALE_OPP").kendoNumericTextBox({
        min: 0,
        step: 1
    });

    $("#PRO_SALE_OPP").kendoNumericTextBox({
        min: 0,
        step: 1,
        max: 100
    });

    $("#submit").click(function () {
        winPopUpModalLoad('Guardando Ticket', 'Espere por favor', 300, 130);

    });

    showDetailsIncident();


    });

    var key_atta = $("#KEY_ATTA").val()

    function AdjuntarComentario() {
        $("#lblTitulo").text("Adjuntar Documentos");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load('/DetailsTicket/AdjuntarArchivosComentario/?KEY_ATTA=' + key_atta);
    }



    /*################################################################## GCR161203 #######################################################################################*/

    var url = "/KnowledgeManagement/ListLeccionesAprendidasTickets";
    var idTicket = "@ViewBag.ID_TICK";
    /*Carga de las leccioens aprendidas y Tickets*/
    $.ajax({
        contentType: 'application/json; charset=utf-8',
        url: url,
        type: "Get",
        data: { idTicket: idTicket },
        datatype: "json",
        cache: false,
        /*  beforeSend: function () {
              swal({ title: "Procesando información, por favor espere.", text: "Detalle de Tickets", showConfirmButton: false, imageUrl: "/images/search_abs.gif" })
          },*/
        success: function (data) {
            if (data) {
                tejerLeccionesAprendidas(data["lecciones"], data["tickets"]);
                swal.close();
            }
        },
        error: function () {
            //Crear_Failed()
        }
    });

    var urlResumenSLA = "/DetailsTicket/ResumenSLA";
    /*Carga de las leccioens aprendidas y Tickets*/
    $.ajax({
        contentType: 'application/json; charset=utf-8',
        url: urlResumenSLA,
        type: "Get",
        data: { idTicket: idTicket },
        datatype: "json",
        cache: false,
        /*  beforeSend: function () {
              swal({ title: "Procesando información, por favor espere.", text: "Detalle de Tickets", showConfirmButton: false, imageUrl: "/images/search_abs.gif" })
          },*/
        success: function (data) {
            if (data) {
                tejerResumenSLA(data["tiempos"], idTicket);
                swal.close();
            }
        },
        error: function () {
            //Crear_Failed()
        }
    });
    /*################################################################## GCR161203 #######################################################################################*/


    var FEC_SCHE = $("#FEC_SCHE").kendoDateTimePicker({ change: startChange }).data("kendoDateTimePicker");

    var FEC_END_REAL = $("#FEC_END_REAL").kendoDateTimePicker({ value: today, change: startChange }).data("kendoDateTimePicker");

    //var FEC_SCHE = $("#FEC_SCHE").kendoDateTimePicker().data("kendoDateTimePicker");

    function addMins(theDate, min) {
        return new Date(theDate.getTime() + min * 60 * 1000);
    }

    var today = new Date();
    var newDate = addMins(new Date(), 1);
    //var today = kendo.date.today();

    var time_from = $("#FROM_TIME").kendoDateTimePicker({ value: today, change: startChange }).data("kendoDateTimePicker");
    var time_to = $("#TO_TIME").kendoDateTimePicker({ value: newDate, change: endChange }).data("kendoDateTimePicker");
    //var time_to = $("#TO_TIME").kendoDateTimePicker({ value: today, change: endChange }).data("kendoDateTimePicker");

    /*################################################################## GCR161203 #######################################################################################*/
    function tejerLeccionesAprendidas(lecciones, tickets) {
        /*  tejerTicket(tickets);*/
        tejerUltimosTicketOP();

        if (parseInt(lecciones.length) > 0) {
            $.each(lecciones, function (index, value) {
                $(".lecciones ul").append('<li><div class="row"><div class="col-md-6 titulo"><a target="_blank"  href="#/KnowledgeManagement/EditLessonLearned/' + lecciones[index].idLeccionAprendida + '"' + ' style="text-decoration:none;"><span class="glyphicon glyphicon-play" aria-hidden="true"></span>' +
                    '<span>' + lecciones[index].Titulo + '</span></a></div>' +
                    '<div class="col-md-6"><div class="stars stars-existing" style="float:right;" title="' + lecciones[index].Puntuacion + ' estrellas' + '"></div></div></div>' +
                    '<div class="row"> <div class="col-md-12">' +
                    ' <span style="display: inline-block; font-size: 11px;margin-left:14px; ">' + lecciones[index].Solucion + '</span></div></div><div class="rayaItms"></div></li>');
                var puntuacion = lecciones[index].Puntuacion;

                $('.stars-existing').starrr({
                    rating: puntuacion
                });
            });
        } else {
            $(".lecciones ul").append('<div class="smallField">No se encontraron Lecciones aprendidas vinculadas');
        }

        var idTicket = "@ViewBag.ID_TICK";
        let idCate = @ViewBag.ID_CATE_MINSUR;


    }

    /*################################################################## GCR161203 #######################################################################################*/
    //function tejerTicket(tickets) {
    //    if (parseInt(tickets.length) > 0) {
    //        $.each(tickets, function (index, value) {

    //            $(".tickets ul").append('<li><div class="row"><div class="col-md-6 titulo"><a target="_blank" href="/DetailsTicket/Index/' + tickets[index].idTicket + '"' + ' style="text-decoration:none;"><span class="glyphicon glyphicon-play" aria-hidden="true"></span>' +
    //                '<span>' + tickets[index].nombreCategoria + '</span></a></div>' +
    //                '</div>' +
    //                '<div class="row"> <div class="col-md-12">' +
    //                ' <span style="display: inline-block; font-size: 11px;margin-left:14px; ">' + tickets[index].ComentarioTicket + '</span></div></div><div class="rayaItms"></div></li>');
    //        });
    //    } else {
    //        $(".lecciones ul").append('<div class="smallField">No se encontraron Lecciones aprendidas vinculadas');
    //    }
    //}

    function tejerUltimosTicketOP() {

        var url = "/DetailsTicket/ListarUltimosTicketsOP";
        var idTicket = "@ViewBag.ID_TICK";
        var idDocuSale = "@ViewBag.IdProyectoSLA";
        /*Carga de las leccioens aprendidas y Tickets*/
        $.ajax({
            contentType: 'application/json; charset=utf-8',
            url: url,
            type: "Get",
            data: { idTicket: idTicket, idDocuSale: idDocuSale },
            datatype: "json",
            cache: false,

            success: function (data) {
                if (data) {
                    var tickets = data["tickets"];
                    if (parseInt(tickets.length) > 0) {
                        $.each(tickets, function (index, value) {

                            $(".ultimostickets ul").append('<li><div class="row"><div class="col-md-6 titulo"><a target="_blank" href="/DetailsTicket/Index/' + tickets[index].idTicket + '"' + ' style="text-decoration:none;"><span class="glyphicon glyphicon-play" aria-hidden="true"></span>' +
                                '<span>' + tickets[index].CodigoTicket + '</span></a></div>' +
                                '</div>' +
                                '<div> <div class="col-md-12">' +
                                ' <label style="display: inline-block; font-size:12px;margin-left:14px; "><b>Titulo: </b>' + tickets[index].TituloTicket + '</label></br>' +
                                ' <label style="display: inline-block; font-size:12px;margin-left:14px; "><b>Categoria: </b>' + tickets[index].nombreCategoria + '</label></br>' +
                                ' <label style="display: inline-block; font-size:12px;margin-left:14px; "><b>Fecha de creación: </b>' + tickets[index].FechaCreacion + '</label>' +
                                '</div ></div > <div class="rayaItms"></div></li > ');
                        });
                    } else {
                        $(".ultimostickets ul").append('<div class="smallField">No se encontraron tickets vinculados a esta OP');
                    }

                    swal.close();
                }
            },
            error: function () {
                //Crear_Failed()
            }
        });


    }

    function tejerResumenSLA(tiempos, idtick) {
        if (parseInt(tiempos.length) > 0) {
            let tieneAplica = false;

            $.each(tiempos, function (index, value) {
                if (tiempos[index].Aplica == 1) {
                    tieneAplica = true;
                    $(".resumensla ul").append(
                        `<div style="display: grid; grid-template-columns: 40px 1fr; gap: 8px; padding: 0 16px;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                            <div style="background-image: url('/Images/` + tiempos[index].CategoriaImagen + `.png'); background-position: center; background-repeat: no-repeat; background-size: cover; border-radius: 50%; width: 24px; height: 24px;"></div>
                            <div style="width: 2px; background-color: #e5e4dc; flex-grow: 1;"></div>
                        </div>
                        <div style="display: flex; flex-direction: column; padding: 12px 0; font-size: 12px;">
                            <p><b>` + tiempos[index].Categoria + ` Comprometido:</b> ` + tiempos[index].SLA + `MIN</p>` +
                        (tiempos[index].FechaFin == 'EN CURSO' || tiempos[index].FechaFin == 'PAUSADO' ?
                            `<p><b>` + tiempos[index].Categoria + ` Efectuado:</b> ` + tiempos[index].FechaFin + `</p>` :
                            `<p><b>` + tiempos[index].Categoria + ` Efectuado:</b> ` + tiempos[index].SLAReal + `MIN`
                            + (tiempos[index].CumpleSLA == 'NO' ? `<b style="color: red;">❌</b>` : `<b style="color: green;">✓</b>`) + `</p>
                                <a class="ver-detalle-principal" onclick="DetalleCorteSLA(` + idtick + `,` + tiempos[index].Id + `, this)">Ver detalle...</a>
                                <div class="detalle-sla" style="display:none;"></div>`
                        ) +
                        `</div>
                    </div>`
                    );
                }
            });

            if (!tieneAplica) {
                $(".resumensla ul").append('<div class="smallField">No se aplica resumen.</div>');
            }

        } else {
            $(".resumensla ul").append('<div class="smallField">No se aplica resumen.</div>');
        }
    }

    function DetalleCorteSLA(idtick, idcategoriasla, elemento) {

        var urlDetalleResumendeSLA = "/DetailsTicket/DetalleResumendeSLA";
        var $detalleContainer = $(elemento).next(".detalle-sla");

        // Si ya está visible, ocultarlo y cambiar el enlace a "Ver detalle..."
        if ($detalleContainer.is(":visible")) {
            $detalleContainer.slideUp(); // Ocultar con animación
            $(elemento).text("Ver detalle..."); // Cambiar texto del enlace
        } else {
            // Hacer la llamada AJAX solo si el detalle no está visible
            $.ajax({
                contentType: 'application/json; charset=utf-8',
                url: urlDetalleResumendeSLA,
                type: "GET",
                data: { idTicket: idtick, idcategoriasla: idcategoriasla },
                datatype: "json",
                cache: false,
                success: function (data) {
                    if (data) {
                        var detalletiempo = data["detalletiempos"];

                        if (parseInt(detalletiempo.length) > 0) {
                            var htmlDetalle = '';

                            $.each(detalletiempo, function (index, value) {
                                htmlDetalle += `<hr><p><b>Desde:</b> ` + value.FechaInicio + ` - <b>Hasta:</b>  ` + value.FechaFin + `</p>`
                                    + `<p><b>Tiempo:</b> ` + value.SLAReal + ` MIN</p>`;
                            });

                            // Agregar el enlace "Ver menos..." al final, con clase específica
                            htmlDetalle += `<a class="ver-detalle-secundario" onclick="OcultarDetalleCorteSLA(` + idtick + `, ` + idcategoriasla + `, this)">Ver menos...</a>`;

                            // Insertar el HTML y mostrar el contenedor
                            $detalleContainer.html(htmlDetalle).slideDown(); // Mostrar con animación
                            $(elemento).hide();
                        }
                    }
                },
                error: function () {
                    console.log("Error al cargar los detalles");
                }
            });
        }
    }

    function OcultarDetalleCorteSLA(idtick, idcategoriasla, elemento) {
        var $detalleContainer = $(elemento).closest(".detalle-sla");

        // Ocultar el detalle y cambiar el texto del enlace principal
        $detalleContainer.slideUp(); // Ocultar con animación
        $detalleContainer.prev(".ver-detalle-principal").text("Ver detalle...").show(); // Cambiar el texto del enlace principal y mostrarlo

        // Si quieres asegurarte de que el enlace principal sea visible, usa show() en el elemento
        $detalleContainer.prev(".ver-detalle-principal").show(); // Asegúrate de que el enlace "Ver detalle..." esté visible
    }


    /*################################################################## GCR161203 #######################################################################################*/
    function Crear_Failed() {
        swal("¡Error al intentar obtener información!", "Cierre de Tickets", "error");
    }
    /*################################################################## GCR161203 #######################################################################################*/
    function startChange() {
        var startDate = time_from.value(),
            endDate = time_to.value();

        if (startDate) {
            startDate = new Date(startDate);
            startDate.setDate(startDate.getDate());
            time_to.min(startDate);
        } else if (endDate) {
            time_from.max(new Date(endDate));
        } else {
            endDate = new Date();
            time_from.max(endDate);
            time_to.min(endDate);
        }
    }

    function endChange() {
        var endDate = time_to.value(),
            startDate = time_from.value();

        if (endDate) {
            endDate = new Date(endDate);
            endDate.setDate(endDate.getDate());
            time_from.max(endDate);
        } else if (startDate) {
            time_to.min(new Date(startDate));
        } else {
            endDate = new Date();
            time_from.max(endDate);
            time_to.min(endDate);
        }
    }

    time_from.max(time_to.value());
    time_to.max(time_to.value());
    //time_to.min(time_from.value());

    jQuery('#IDPLAN').on('change', function () {

        $.ajax({
            url: '/Plantilla/ObtenerDescripcionPlantilla/',
            data: { IdGrupo: $("#IDGRUPO").val(), IdPlan: $("#IDPLAN").val() },
            type: 'GET',
            dataType: 'text',
            success: function (data) {


                $("#COM_DETA_TICK").data('kendoEditor').value(data);
                //alert(data);
                //jQuery("#SUM_TICK").data('kendoEditor').value(data);

            },
            error: function (data) {
            },
        });
    });

    var IDGRUPO = $("#IDGRUPO").kendoComboBox({
        autoBind: true,
        dataTextField: "NOMBRE",
        dataValueField: "IDGRUPO",
        //placeholder: "Seleccione un grupo",
        filter: "contains",
        delay: 500,
        minLength: 0,
        suggest: true,
        dataSource: {
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {
                read: "/Grupo/ListarCboGrupoCuentaEstado?ID_ACCO=" + @Session["ID_ACCO"] + "&var=" + Math.random()
                }
            }
        }).data("kendoComboBox");


    var IDPLAN = $("#IDPLAN").kendoComboBox({
        autoBind: true,
        cascadeFrom: "IDGRUPO",
        /*placeholder: "",*/
        dataTextField: "NOMBRE",
        dataValueField: "ID_PLAN",
        filter: "contains",
        delay: 500,
        minLength: 0,
        suggest: true,
        dataSource: {
            serverFiltering: true,
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {

                read: "/Plantilla/ListarPlantillaGrupo?ID_TIPOPLAN=2"

            }
        }
    }).data("kendoComboBox");



    $("#COM_DETA_TICK").kendoEditor({
        encoded: false,
        paste: OnPaste
    });

    var ID_STAT = $("#ID_STAT").kendoComboBox({
        autoBind: true,
        dataTextField: "NAM_STAT",
        dataValueField: "ID_STAT",
        dataSource: {
            //type: "odata",
            serverFiltering: false,
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {
                read: "/StatusTicket/StatusConditionEdata/@ViewBag.ID_TICK"
            }
        }
    }).data("kendoComboBox");

    $("#ID_STAT").on('change', function (e) {
        /* $("#divMotivoEspera").attr("hidden", true);*/
        var cbEstado = $("#ID_STAT").val();
        console.log(cbEstado);
        if (cbEstado == 2 || cbEstado == 1) {
            $("#DivFechaProgramada").attr("hidden", true);
            $("#DivControlRemoto").attr("hidden", true);
            /*$("#DivEsperaCliente").removeAttr("hidden");*/
            $("#DivFechaFinReal").attr("hidden", true);
            $("#divBolsaHoras").attr("hidden", true);
            $("#divTipoResolucion").attr("hidden", true);
            $("#divFormularioEnvioCorreo").attr("hidden", true);
            $("#divComentarioyBotones").attr("hidden", false);

            $('#correos').prop('required', false);
            $('#asunto').prop('required', false);
            $('#cuerpo').prop('required', false);
        }
        else if (cbEstado == 5) {

            $("#DivControlRemoto").attr("hidden", true);
            $("#divBolsaHoras").attr("hidden", true);
            $("#DivFechaFinReal").attr("hidden", true);
            $("#divTipoResolucion").attr("hidden", true);
            $("#divFormularioEnvioCorreo").attr("hidden", true);
            $("#divComentarioyBotones").attr("hidden", false);

            $('#correos').prop('required', false);
            $('#asunto').prop('required', false);
            $('#cuerpo').prop('required', false);

        }
        else if (cbEstado == 4) {
            $("#DivFechaProgramada").attr("hidden", true);
            //$("#DivControlRemoto").removeAttr("hidden");
            //$("#DivEsperaCliente").removeAttr("hidden");
            $("#DivFechaFinReal").removeAttr("hidden");
            $("#divTipoResolucion").attr("hidden", false);
            $("#divFormularioEnvioCorreo").attr("hidden", false);
            $('#correos').prop('required', true);
            $('#asunto').prop('required', true);
            $('#cuerpo').prop('required', true);
            $("#correos").val('@ViewBag.Para');
            $("#cc").val('@ViewBag.Cc');
            $("#asunto").val('@Html.Raw(ViewBag.Asunto)');


            $("#divComentarioyBotones").attr("hidden", true);
            $("#divBolsaHoras").removeAttr("hidden");
            $('input[name="TipoResolucion"]').iCheck('uncheck');
            ObtenerBolsaHoras(@ViewBag.ID_TICK);

            } else {
        $("#DivFechaProgramada").attr("hidden", true);
        $("#DivControlRemoto").attr("hidden", true);
        $("#DivFechaFinReal").attr("hidden", true);
        $("#DivFechaFinReal").attr("hidden", true);
        $("#DivEsperaCliente").attr("hidden", true);
        $("#divTipoResolucion").attr("hidden", true);
        $("#divFormularioEnvioCorreo").attr("hidden", true);
        $("#divComentarioyBotones").attr("hidden", false);
        $("#divBolsaHoras").attr("hidden", true);

        $('#correos').prop('required', false);
        $('#asunto').prop('required', false);
    }

        });

    //ID_STAT.bind("change", function (e) {
    //    if (ID_STAT.dataItem().ID_STAT == 5) {
    //        $("#fechaScheduled").removeClass('divHide');
    //        $("#fechaRealTermino").addClass('divHide');
    //        $("#divControlRemoto").addClass('divHide');
    //        $("#divTipoResolucion").addClass('divHide');
    //    }
    //    else {
    //        if (ID_STAT.dataItem().ID_STAT == 4) {
    //            $("#fechaScheduled").addClass('divHide');
    //            $("#fechaRealTermino").removeClass('divHide');
    //            $("#divControlRemoto").removeClass('divHide');
    //            $("#divTipoResolucion").removeClass('divHide');

    //            //IniciarLeccionAprendida();
    //            //$("#submit").trigger('click');
    //        }
    //        else {
    //            $("#fechaScheduled").addClass('divHide');
    //            $("#fechaRealTermino").addClass('divHide');
    //            $("#divControlRemoto").addClass('divHide');
    //            $("#divTipoResolucion").addClass('divHide');
    //        }
    //    }
    //});
    /* }*/





    //status sale
    $("#ID_STAT_SALE_OPP").kendoComboBox({
        dataTextField: "NAM_STAT_SALE_OPPO",
        dataValueField: "ID_STAT_SALE_OPPO",
        filter: "contains",
        autoBind: false,
        delay: 500,
        minLength: 0,
        suggest: true,
        dataSource: {
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {
                read: "/StatusSalesOpportunities/ListAll?var=" + Math.random()
            }
        }
    }).data("kendoComboBox");

    $("#ID_QUEU").kendoComboBox({
        dataTextField: "DES_QUEU",
        dataValueField: "ID_QUEU",
        filter: "contains",
        autoBind: false,
        //template: '<div style="text-transform:capitalize">' +
        //    '${data.DES_QUEU}</div>',
        dataSource: {
            serverFiltering: false,
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {
                read: "/AccountQueue/ListByAcco?var=" + Math.random()
            },
            sort: { field: "DES_QUEU", dir: "asc" }
        }
    }).data("kendoComboBox");




    $("#ID_PERS_ENTI").kendoComboBox({
        autoBind: false,
        filter: "contains",
        cascadeFrom: "ID_QUEU",
        dataTextField: "ASSI",
        dataValueField: "ID_PERS_ENTI",
        delay: 500,
        placeholder: "Seleccionar ... ",
        dataSource: {
            serverFiltering: true,
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {
                read: {
                    url: function () {
                        var valor = $('#ID_PERS_ENTI').data('kendoComboBox')._prev;
                        if (valor == undefined) {
                            valor = ""
                        }
                        var ruta = "/AccountEntity/AsignadoPorCola?ID_QUEU=" + $("#ID_QUEU").val() + "&VALOR=" + valor;
                        return ruta
                    }
                }
            },
            sort: { field: "ASSI", dir: "asc" }
        }
    }).data("kendoComboBox");

    if (@ViewBag.TicketProyecto == 1) {
        $("#subcategorizacionPry").removeClass("divHide");
        $("#divCtrlRemot").removeClass("divHide");
    } else {
        $("#subcategorizacionPry").addClass("divHide");
        $("#divCtrlRemot").addClass('divHide');
    }
    //Subcategorización de proyectos
    var cboEtapa = $("#cboEtapa").kendoComboBox({
        placeholder: "",
        dataTextField: "Nombre",
        dataValueField: "Id",
        filter: "contains",
        autoBind: true,
        delay: 500,
        minLength: 0,
        suggest: true,
        dataSource: {
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {
                read: "/Proyectos_Etapa/CboListarEtapa"
            }
        }
    });
    var cboActividad = $("#cboActividad").kendoComboBox({
        placeholder: "",
        dataTextField: "Nombre",
        dataValueField: "Id",
        filter: "contains",
        autoBind: true,
        delay: 500,
        minLength: 0,
        suggest: true,
        dataSource: {
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {
                read: "/Proyectos_Actividad/CboListarActividad"
            }
        }
    });
    var cboSubcategoria = $("#cboSubcategoria").kendoComboBox({
        placeholder: "",
        dataTextField: "Nombre",
        dataValueField: "Id",
        filter: "contains",
        autoBind: true,
        delay: 500,
        minLength: 0,
        suggest: true,
        dataSource: {
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {
                read: "/Proyectos_SubCategoria/CboListarSubcategoria"
            }
        }
    });

    var ID_RAZON = $("#IdRazon").kendoComboBox({
        autoBind: true,
        cascadeFrom: "ID_STAT",
        dataTextField: "text",
        dataValueField: "id",
        filter: "contains",
        index: 0,
        delay: 500,
        minLength: 0,
        suggest: true,
        dataSource: {
            serverFiltering: true,
            schema: {
                data: "Data",
                total: "Count"
            },
            transport: {
                read: "/StatusTicket/ListarRazonxEstado?IDESTADO=" + 0 + "&Tipo=" + 1 + "&var=" + Math.random()

            }
        }
    }).data("kendoComboBox");

    function IniciarLeccionAprendida() {

        //$("#miModal").show();
        var htmlForm = '<div id="FormLeccionAprendida"></div>';
        var id = $("#ID_TICK").val();
        winFormPopup("Nueva lección Aprendida", htmlForm);
        $("#FormLeccionAprendida").load("/KnowledgeManagement/GenerarLeccionTicketProblema?id=" + id + "&var=" + Math.random());
        //load("/Ticket/viewDetalleUsuario?id=" + idUsuario + "&var=" + Math.random());
        @*/*?id=" + "@ViewBag.ID_COMP" + "&var=" + Math.random()*/*@
    }


    /*Modificado para la gestión de conocimiento y problemas*/
    function uploadDone(conf, msg, nivel1, nivel2, nivel3, nivel4, idTema, idtick, nameNivel1, nameNivel2, nameNivel3, nameNivel4, nameTema, idEstado, Flagproblema) {
        console.log(msg);
        closeWinModalPopUpLoad();
        if (conf == 'OK') {
            /*################################################################## GCR161203 #######################################################################################*/
            if (idEstado == 4) {

                if (Flagproblema == "True") {

                    var title = 'Información Guardada';
                    var body = "<div style='border-bottom:1px dotted #dadada;padding:0px 0px 20px 0px;'>"
                        + "<div style='padding:10px 0px 10px 0px;'>Detail Ticket information was succesfully saved</div>"
                        + "<div style='padding:10px 0px 10px 0px;'>Code: " + msg + "</div>" +
                        "<div style='float:right; padding:30px 6px 0px 6px; font-size:0.9em;'>" +
                        "<button id='btnContinues' class='k-button'>Continue</button>" +
                        "</div></div>";
                    swal({
                        title: title,
                        type: 'success',
                        text: 'Code: ' + msg,
                        focusConfirm: false,
                        confirmButtonText:
                            'Continue',
                        confirmButtonAriaLabel: 'Thumbs up, great!'

                    }, function () {
                        location.reload();
                    })
                    //winPopUpModal(title, body, 400, 185);

                    $("#closebtnmodal").click(function () {

                        //location.reload(true);
                        location.reload(true);
                        // var url = "http://" + location.host + "/#/NewLessonLearned?nivel1=" + nivel1 + "&nivel2=" + nivel2 + "&nivel3=" + nivel3 + "&nivel4=" + nivel4 + "&idTema=" + idTema + "&idtick=" + idtick + "&nameNivel1=" + nameNivel1 + "&nameNivel2=" + nameNivel2 + "&nameNivel3=" + nameNivel3 + "&nameNivel4=" + nameNivel4 + "&nameTema=" + nameTema;
                        // window.open(url, '_blank');
                    });
                    $("#btnContinues").click(function () {
                        location.reload(true);
                        //var url = "http://" + location.host + "/#/NewLessonLearned?nivel1=" + nivel1 + "&nivel2=" + nivel2 + "&nivel3=" + nivel3 + "&nivel4=" + nivel4 + "&idTema=" + idTema + "&idtick=" + idtick + "&nameNivel1=" + nameNivel1 + "&nameNivel2=" + nameNivel2 + "&nameNivel3=" + nameNivel3 + "&nameNivel4=" + nameNivel4 + "&nameTema=" + nameTema;
                        //window.open(url, '_blank');
                    });
                } else {
                    var title = 'Información Guardada';
                    var body = "<div style='border-bottom:1px dotted #dadada;padding:0px 0px 20px 0px;'>"
                        + "<div style='padding:10px 0px 10px 0px;'>Detail Ticket information was succesfully saved</div>"
                        + "<div style='padding:10px 0px 10px 0px;'>Code: " + msg + "</div>" +
                        "<div style='float:right; padding:30px 6px 0px 6px; font-size:0.9em;'>" +
                        "<button id='btnContinues' class='k-button'>Continue</button>" +
                        "</div></div>";

                    //winPopUpModal(title, body, 400, 185);

                    $("#closebtnmodal").click(function () {

                        location.reload(true);
                        var url = "http://" + location.host + "/KnowledgeManagement/NewLessonLearned?nivel1=" + nivel1 + "&nivel2=" + nivel2 + "&nivel3=" + nivel3 + "&nivel4=" + nivel4 + "&idTema=" + idTema + "&idtick=" + idtick + "&nameNivel1=" + nameNivel1 + "&nameNivel2=" + nameNivel2 + "&nameNivel3=" + nameNivel3 + "&nameNivel4=" + nameNivel4 + "&nameTema=" + nameTema;
                        window.open(url, '_blank');
                    });

                    swal({
                        title: title,
                        text: 'Code: ' + msg,
                        type: "success",
                        //showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "Continue",
                        //cancelButtonText: "No, cancel plx!",
                        closeOnConfirm: false,
                        //closeOnCancel: false
                    },
                        function (isConfirm) {

                            location.reload(true);
                        }
                    );

                    //$("#btnContinues").click(function () {
                    //    swal({
                    //        title: "¿Desea agregar una lección aprendida a esta operación realizada?",
                    //        type: "info",
                    //        showCancelButton: true,
                    //        confirmButtonColor: "#DD6B55",
                    //        cancelButtonText: "No",
                    //        confirmButtonText: "Sí",
                    //        closeOnConfirm: false
                    //    }, function (dismiss) {
                    //        if (dismiss) {

                    //            location.reload(true);
                    //            var url = "http://" + location.host + "/KnowledgeManagement/NewLessonLearned?nivel1=" + nivel1 + "&nivel2=" + nivel2 + "&nivel3=" + nivel3 + "&nivel4=" + nivel4 + "&idTema=" + idTema + "&idtick=" + idtick + "&nameNivel1=" + nameNivel1 + "&nameNivel2=" + nameNivel2 + "&nameNivel3=" + nameNivel3 + "&nameNivel4=" + nameNivel4 + "&nameTema=" + nameTema;
                    //            window.open(url, '_blank');
                    //        } else
                    //            location.reload(true);
                    //    })
                    //});
                }

                const button = document.querySelector('#btnEnviarCorreo');
                button.disabled = false;
                const buttondetalle = document.querySelector('#submitDetail');
                buttondetalle.disabled = false;
                location.reload(true);
            }
            else {

                var title = 'Información Guardada';
                var body = "<div style='border-bottom:1px dotted #dadada;padding:0px 0px 20px 0px;'>"
                    + "<div style='padding:10px 0px 10px 0px;'>Detail Ticket information was succesfully saved</div>"
                    + "<div style='padding:10px 0px 10px 0px;'>Code: " + msg + "</div>" +
                    "<div style='float:right; padding:30px 6px 0px 6px; font-size:0.9em;'>" +
                    "<button id='btnContinues' class='k-button'>Continue</button>" +
                    "</div></div>";

                swal({
                    title: title,
                    type: 'success',
                    text: 'Code: ' + msg,
                    focusConfirm: false,
                    confirmButtonText:
                        'Continue',
                    confirmButtonAriaLabel: 'Thumbs up, great!'

                }, function () {
                    location.reload();
                })

                //winPopUpModal(title, body, 400, 185);

                $("#closebtnmodal").click(function () {

                    location.reload(true);
                });
                $("#btnContinues").click(function () {
                    location.reload(true);
                });
            }

        }
        else if (conf == 'TieneHijosGF') {
            swal({
                type: 'info',
                title: 'Tickets Hijos Activos',
                text: msg,
                confirmButtonText:
                    'Continue',
            }, function () {
                location.reload();
            })
        }
        else {
            swal({
                type: 'info',
                title: '@ResourceLanguaje.Resource.InformationMissing',
                text: msg,
                confirmButtonText:
                    'Continue',
            }, function () {
                /*console.log(msg);*/
                if (msg == "Error enviando correo.") {
                    location.reload();
                } else {

                    const button = document.querySelector('#btnEnviarCorreo');
                    button.disabled = false;
                    const buttondetalle = document.querySelector('#submitDetail');
                    buttondetalle.disabled = false;
                }

            })

        }
    }

    function perdioSesion() {
        alert('perdio sesion')
        swal({
            title: 'Algo salio mal',
            type: 'error',
            text: 'Se perdió la conexión',
            focusConfirm: false,
            confirmButtonText: 'Continuar',
        }, function () {

            location = "http://" + location.host + `/Home/Principal`;
        })
    }
    function MensajeError(conf, msga) {

        alert(1);
    }

    function detailUser(id) {
        var dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: "/AccountEntity/DetailPerson/" + id,
                    type: "GET",
                    dataType: "json",
                    data: {
                        ran: Math.random()
                    }
                }
            },
            autoSync: true,
            serverFiltering: true,
            filter: { field: "Status", operator: "eq", value: 0 },
            serverPaging: true,
            pageSize: 15,
            schema: {
                data: "Data",
                total: "Count"
            }
        });

        $("#divDetu").empty();

        $("#divDetu").kendoListView({
            dataSource: dataSource,
            template: kendo.template($("#templdu").html())
        });
    }

    function ListAllAttach() {

        $("#divAttachFiles").kendoGrid({
            dataSource: {
                transport: {
                    read: {
                        url: "/DetailsTicket/AttaAllTick/" + "@ViewBag.ID_TICK",
                        type: "GET",
                        dataType: "json",
                        data: {
                            ran: Math.random()
                        }
                    }
                },
                schema: {
                    data: "Data",
                    total: "Count",
                    model: {
                        fields: {
                            NAM_ATTA: { type: "string" },
                            ID_ATTA: { type: "number" },
                            EXT_ATTA: { type: "string" },
                            NAM_TYPE_DOCU_ATTA: { type: "string" }
                        }
                    }
                },
                group: {
                    field: "NAM_TYPE_DOCU_ATTA", aggregates: [
                        { field: "NAM_ATTA", aggregate: "count" }
                        , { field: "NAM_TYPE_DOCU_ATTA", aggregate: "count" }
                    ]
                }
            },
            sortable: true,
            filterable: true,
            pageable: false,
            //height: 185,
            //columns: [
            //    { field: "NAM_ATTA", title: "File Name", template: "<a href='#: NAM_ATTA #_#: ID_ATTA ##: EXT_ATTA #' target='_blank'>#: NAM_ATTA # </a>" }
            columns: [
                {
                    field: "NAM_ATTA", title: "File Name", template: function (query2) {
                        if (query2.EXT_ATTA == '.pdf' || query2.EXT_ATTA == '.jpg' || query2.EXT_ATTA == '.png' || query2.EXT_ATTA == '.txt') {
                            //return "<a href='DetailsTicket/VerDocumento/#: NAM_ATTA #' target='_blank'>#: NAM_ATTA # </a>"
                            return "<a href='/DetailsTicket/VerDocumento/" + query2.NAM_ATTA + '_' + query2.ID_ATTA + query2.EXT_ATTA + "' target='_blank'>" + query2.NAM_ATTA + "</a>"
                        }
                        else {
                            return "<a href='/DetailsTicket/DescargarArchivo/" + query2.NAM_ATTA + '_' + query2.ID_ATTA + query2.EXT_ATTA + "' target='_blank'>" + query2.NAM_ATTA + "</a>"
                        }
                    }

                }
                , { field: "NAM_TYPE_DOCU_ATTA", title: "Type Attach", groupHeaderTemplate: "#= value # (#= count#)" }
            ]
        });
    }

    function showDetailsIncident() {

        $.ajax({
            url: "/DetailsTicket/ListByIdTick/" + "@ViewBag.ID_TICK",
            data: "var=" + Math.random(),
            type: "GET",
            dataType: "json",
            success: function (source) {
                data1 = source;

                $("#divDetaTicket").empty();
                $("#divComentario").empty();
                $("#divActivities").empty();
                $("#divDetails").empty();

                // datos actualizados


                $.each(data1['datadeta'], function (index, value) {


                    $("#divDetaTicket").append(
                        '<div class="form-row">' +
                        '<div class="col-xs-1">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Estado </label>' +
                        '</br>' +
                        '<p id="" for="" style="font-size: 12px; font-weight: bold; color: white; padding: 5px; background-color:' + (data1['datadeta'][index]['ColorEstado']) + '; border-radius: 4px; display: inline-block;"> ' +
                        (data1['datadeta'][index]['NAM_STAT']) +
                        ' </p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-11">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Título</label>' +
                        '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['Titulo']) +
                        '</p>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div class="form-row">' +
                        ((data1['datadeta'][index]['Fabricante']) != '' ?
                            '<div class="col-xs-1">' +
                            '<div class="form-group">' +
                            '<label id="" for="" class="smallTitulo">Fabricante </label>' +
                            '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['Fabricante']) + '</p>' +
                            '</div>' +
                            '</div>' : '')
                        +
                        ((data1['datadeta'][index]['FabricanteSoporte']) != '' ?
                            '<div class="col-xs-1">' +
                            '<div class="form-group">' +
                            '<label id="" for="" class="smallTitulo">Fabricante </label>' +
                            '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['FabricanteSoporte']) + '</p>' +
                            '</div>' +
                            '</div>' : '') +

                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Usuario Solicitante </label>' +
                        '<p id="" for="" class="smallCampo"> ' + (data1['datadeta'][index]['Sol']) + ' </p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Usuario Afectado </label>' +
                        '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['AEU']) + '</p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-1">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Nivel de Servicio </label>' +
                        '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['TipoSLA']) + ' - ' + (data1['datadeta'][index]['SLA']) + ' Horas </p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Tiempo de Expiración </label>' +
                        '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['EXP_TIME']) + '</p>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div class="form-row">' +
                        ((data1['datadeta'][index]['ID_DOCU_SALE']) != 0 ?
                            '<div class="col-xs-1">' +
                            '<div class="form-group">' +
                            '<label id="" for="" class="smallTitulo">OP </label>' +
                            '<p id="" for="" class="smallCampo"><a href="/OrderForm/Details/' + (data1['datadeta'][index]['ID_DOCU_SALE']) + '" target="_blank" style="text-decoration:none;" title="View OP">' + (data1['datadeta'][index]['COD_TYPE_DOCU_SALE']) + ' ' + (data1['datadeta'][index]['NUM_OP']) + '</a></p>' +
                            '</div>' +
                            '</div>' : '') +
                        ((data1['datadeta'][index]['ID_QUEU']) == 26 ?
                            '<div class="col-xs-1">' +
                            '<div class="form-group">' +
                            '<label id="" for="" class="smallTitulo">Monto </label>' +
                            '<p id="" for="" class="smallCampo">$ ' + (data1['datadeta'][index]['AMM']) + '</p>' +
                            '</div>' +
                            '</div>' : '') +
                        ((data1['datadeta'][index]['ID_QUEU']) == 26 ?
                            '<div class="col-xs-1">' +
                            '<div class="form-group">' +
                            '<label id="" for="" class="smallTitulo">Ganancia </label>' +
                            '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['PROF']) + ' % </p>' +
                            '</div>' +
                            '</div>' : '') +
                        //            '</div>' +
                        //            '</div>'+
                        //'<div class="form-row">' +



                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Prioridad </label>' +
                        '<p id="" for="" class="smallCampo"> ' + (data1['datadeta'][index]['NAM_PRIO']) + ' </p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +

                        '<label id="" for="" class="smallTitulo">Unidad de Negocio</label>' +
                        '<p id="" for="" class="smallCampo"> ' +
                        (data1['datadeta'][index]['CATE_1'])

                        +
                        '</p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +

                        '<label id="" for="" class="smallTitulo">Macroservicio </label>' +
                        '<p id="" for="" class="smallCampo"> ' +
                        (data1['datadeta'][index]['CATE_2'])

                        +
                        ' </p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +


                        '<label id="" for="" class="smallTitulo">Servicio </label>' +
                        '<p id="" for="" class="smallCampo"> ' +
                        (data1['datadeta'][index]['CATE_3'])

                        +
                        ' </p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +


                        '<label id="" for="" class="smallTitulo">Incidente/Requerimiento </label>' +
                        '<p id="" for="" class="smallCampo"> ' +
                        (data1['datadeta'][index]['CATE_4'])

                        +

                        ' </p>' +
                        '</div>' +
                        '</div>' +
                        ((data1['datadeta'][index]['TipoInforme']) != '' ?
                            '<div class="col-xs-1">' +
                            '<div class="form-group">' +
                            '<label id="" for="" class="smallTitulo">Tipo de Informe </label>' +
                            '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['TipoInforme']) + '</p>' +
                            '</div>' +
                            '</div>' : '') +


                        '</div>'

                        +

                        '<div class="form-row">' +
                        '<div class="col-xs-1">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Fuente </label>' +
                        '<p id="" for="" class="smallCampo"> ' + (data1['datadeta'][index]['NAM_SOUR']) + ' </p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Fecha Creación </label>' +
                        '<p id="" for="" class="smallCampo"> ' + (data1['datadeta'][index]['CREATE_TICK']) + ' </p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Fecha Modificación</label>' +
                        '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['MODIFIED_TICK']) + '</p>' +
                        '</div>' +
                        '</div>' +
                        ((data1['datadeta'][index]['ID_STAT']) == 5 ?
                            '<div class="col-xs-2">' +
                            '<div class="form-group">' +
                            '<label id="" for="" class="smallTitulo">Fecha Programación</label>' +
                            '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['DATE_SCHE']) + '</p>' +
                            '</div>' +
                            '</div>' : '') +
                        '<div class="col-xs-1">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Adjuntos </label>' +
                        '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['ATTA_TOT']) + ' </p>' +
                        '</div>' +
                        '</div>' +

                        '<div class="col-xs-1">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Servicio </label>' +
                        '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['SERVICE']) + '</p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="smallTitulo">Fecha Recepción De Solicitud </label>' +
                        '<p id="" for="" class="smallCampo">' + (data1['datadeta'][index]['FechaRecepcionSolicitud']) + '</p>' +
                        '</div>' +
                        '</div>' +

                        (data1['datadeta'][index]['MotivoEspera'] != '' && (data1['datadeta'][index]['ID_STAT'] == 5 || data1['datadeta'][index]['ID_STAT'] == 9) ?
                            '<div class="col-xs-2">' +
                            '<div class="form-group">' +
                            '<label class="smallTitulo">Motivo de Espera</label>' +
                            '<p class="smallCampo">' + (data1['datadeta'][index]['MotivoEspera']) + '</p>' +
                            '</div>' +
                            '</div>' : '') +
                        '</div>' +

                        '<div class="form-row">' +
                        '<div class="col-xs-2">' +
                        '<div class="form-group">' +
                        '<a><img width="80" class="rounded-circle" src="/Content/Fotos/' + (data1['datadeta'][index]['PHOTO']) + '.jpg"/></a>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-md-10">' +
                        '<div class="main-card mb-3 card mr-1" style="overflow:auto;">' +
                        '<div class="card-header">' +
                        '<i class="header-icon lnr-laptop-phone icon-gradient bg-plum-plate"> </i>Creado por ' + (data1['datadeta'][index]['CREA_BY']) +
                        '<div style="padding-top:3px; padding-right:1%; float:right; width:64%; text-transform:capitalize; text-align:right;">' +
                        '<div >' +
                        'Asignado A ' +
                        (data1['datadeta'][index]['ASSI_TO']) +
                        ("@ViewBag.ACCESO_EDIT" == 1 ?
                            '|<a style="cursor:pointer; color:#369;" href="javascript:void(0)" data-toggle="modal" data-target="#miModal"  onclick="EditComment(@ViewBag.ID_TICK)"> Editar </a>'
                            : '') +
                        ("@ViewBag.ACCESO_SEND_SURVEY" == 1 && (data1['datadeta'][index]['ID_STAT']) == 6 ?
                            '|<a style="cursor:pointer; color:#369;" href="javascript:void(0)" onclick="FcnSendSurvey(@ViewBag.ID_TICK)"> Enviar Encuesta </a>'
                            : '') +
                        '</div>' +

                        '</div>' +
                        '</div>' +
                        '<div class="card-body">' +
                        '<p>' + (data1['datadeta'][index]['SUM_TICK']) + '</p>' +
                        '<p>' + (data1['datadeta'][index]['Adicional1']) + '</p>' +
                        '<p>' + (data1['datadeta'][index]['Adicional2']) + '</p>' +
                        '</div>' +
                        '<div class="card-footer">' +
                        (data1['datadeta'][index]['ATTA']) +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>'

                    );


                    if ((data1['datadeta'][index]['ID_ACCO']) == 4) {
                        $("#divCIA").html(data1['datadeta'][index]['CIA'] + ' - ' + data1['datadeta'][index]['COMPEND']);
                        $("#divCIA").attr("title", data1['datadeta'][index]['COMP'] + ' - ' + data1['datadeta'][index]['COMPEND']);
                    }

                    $("#idUsuario").val(data1['datadeta'][index]['ID_PERS_ENTI_END']);
                    ListAllAttach();



                });

                $.each(data1['data'], function (index, value) {
                    $("#divActivities").append(
                        '<a href="#" onclick="mover(' + (data1['data'][index]['ID_DETA_TICK']) + ')"><div class="listActCont">' +
                        '<div class="form-row">' +
                        '<div class="col-md-4">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="" style="text-transform:capitalize">' + (data1['data'][index]['NAM_TYPE_DETA_TICK']) + '-' + (data1['data'][index]['MinutosTranscurridos']) + ' m' + '</label>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-md-4">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="" style="text-transform:capitalize">' + (data1['data'][index]['CREATE_DETA_INCI']) + '</label>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-md-4">' +
                        '<div class="form-group">' +
                        '<label id="" for="" class="" style="text-transform:capitalize">' + (data1['data'][index]['PERS']) + '</label>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</a>'
                    );

                    $("#divDetails").append(

                        '<div class="chat-wrapper" id="' + (data1['data'][index]['ID_DETA_TICK']) + '">' +
                        '<div class="chat-box-wrapper" >' +
                        '<div>' +
                        '<div class="avatar-icon-wrapper mr-1">' +
                        '<div class="avatar-icon avatar-icon-lg rounded">' +
                        '<img src="/Content/Fotos/' + (data1['data'][index]['PHOTO']) + '.jpg" />' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div>' +
                        ((("@ViewBag.ACCESO_EDIT" == 1 || "@ViewBag.UserId" == (data1['data'][index]['UserId'])) && ((data1['data'][index]['NAM_STAT']) != "RESUELTO - Solución permanente" && (data1['data'][index]['NAM_STAT']) != "RESUELTO - Solución temporal")) ?
                            '<div class="float-right text-muted small">' +
                            '<a style="color:#369; cursor:pointer;" data-toggle="modal" data-target="#miModal" onclick="EditDetailComment(' + data1['data'][index]['INEX'] + ')"> Edit</a>' +
                            '</div>' : '') +
                        '<label href="javascript:void(0)" style="color:#336699;text-transform:capitalize">' + (data1['data'][index]['PERS']).toLowerCase() + ' </label> <label> ' + (data1['data'][index]['CREATE_DETA_INCI']) + ' ' + (data1['data'][index]['Causa']) + '</label>' +
                        '<div class="text-muted small">Inicio Actividad: ' + (data1['data'][index]['DATE_INIC']) + ' &nbsp; &nbsp; &nbsp; &nbsp; Fin Actividad: ' + (data1['data'][index]['DATE_END']) + '</div>' +
                        '<div class="text-muted small" style="text-transform:capitalize">' + (data1['data'][index]['NAM_TYPE_DETA_TICK']).toLowerCase() + ' ' +
                        ((data1['data'][index]['ID_TYPE_DETA_TICK']) == 3 ? (": " + (data1['data'][index]['NAM_STAT']).toLowerCase() + " " + (data1['data'][index]['FEC_SCHE'])) : '') +
                        ((data1['data'][index]['ID_TYPE_DETA_TICK']) == 2 ? (": " + data1['data'][index]['ASSI']).toLowerCase() : '') +
                        ((data1['data'][index]['ID_TYPE_DETA_TICK']) == 8 ? (": " + data1['data'][index]['NAM_STAT_SALE_OPPO']).toLowerCase() + " | Ammount: $ " + (data1['data'][index]['AMM_SALE_OPP']) + " | Profit:" + (data1['data'][index]['PRO_SALE_OPP']) + " %" : '') +
                        ((data1['data'][index]['ID_TYPE_DETA_TICK']) == 9 ? (": " + data1['data'][index]['FROM_TIME'] + " - " + data1['data'][index]['TO_TIME']) : '') +
                        '</div>' +
                        ((data1['data'][index]['ID_TYPE_DETA_TICK']) == 3 &&
                            (['programado', 'en espera'].includes(data1['data'][index]['NAM_STAT'].toLowerCase())) &&
                            (data1['data'][index]['MotivoEspera']) != ''
                            ? '<div class="text-muted small">Motivo de Espera: ' + (data1['data'][index]['MotivoEspera']) + '</div>'
                            : '') +
                        '<div class="chat-box">' +
                        '<div class="form" id="clipboard' + (data1['data'][index]['ID_DETA_TICK']) + '">' +
                        (data1['data'][index]['COM_DETA_INCI']) +
                        '</div>' +
                        '</div>' +
                        '<div class="small mt-2">' +
                        (data1['data'][index]['ADJ']) +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>');

                });

                $.each(data1['listaLeccionAprendida'], function (index, value) {

                    /*Gestión de problemas*/
                    $("#divLeccionAprendida").append('<div class="detailsSummary">' +
                        '<div id="detSummary">' +
                        '<div class="containerdt">' +
                        '<div class="userData">' +
                        '<div class="asignedImage"><div ><img src="/Content/Fotos/prueba.jpg"/></div></div>' +
                        '</div>' +

                        '<div class="messageData">' +
                        '<div class="messageArrow"></div>' +
                        '<div class ="messageBoxDet">' +
                        '<label>Lección aprendida Ticket problema</label> <a target="_blank" href="#/KnowledgeManagement/EditLessonLearned/' + data1['listaLeccionAprendida'][index]['idLeccionAprendida'] + '"' + ' style="text-decoration:none;"><span class="glyphicon glyphicon-play" aria-hidden="true"></span><span>' + data1['listaLeccionAprendida'][index]['idLeccionAprendida'] + '</span></a>' +
                        '</div>' +
                        '<div class="msgBoxBody">' +
                        '<spam><label>Título</label><p>' +
                        (data1['listaLeccionAprendida'][index]['Titulo']) +
                        '</p><label>Categoría</label><p>' +
                        (data1['listaLeccionAprendida'][index]['Categoria']) +
                        '</p></spam>' +
                        '</p><label>Descripción</label><p>' +
                        (data1['listaLeccionAprendida'][index]['Descripcion']) +
                        '</p></spam>' +
                        //   '</p><label>Solución Aplicada</label><p>' +
                        //(data1['listaLeccionAprendida'][index]['SolucionAplicada']) +
                        //'</p></spam>' +
                        '</p><label>Impacto</label><p>' +
                        (data1['listaLeccionAprendida'][index]['Impacto']) +
                        '</p></spam>' +
                        '</p><label>Solución Temporal</label><p>' +
                        (data1['listaLeccionAprendida'][index]['SolucionTemporal']) +
                        '</p></spam>' +
                        '</p><label>Solución Definitiva</label><p>' +
                        (data1['listaLeccionAprendida'][index]['SolucionDefinitiva']) +
                        '</p></spam>' +
                        '</div>' +
                        '</div>' +//message Data
                        '</div>' +
                        '</div>' +
                        '</div>');
                    /*Fin*/
                });

                @*if ("@ViewBag.ID_ACCO" == 60) {
                    ListarComentariosTareas();
                }*@
    },
            error: function (source) {
                console.error("Error al obtener datos del incidente:", source);
            }
        });

    }



    function obtenerlocal() {

        $myLocalStorage = JSON.parse(localStorage.getItem("palabras"));

    }


    function removestorage() {
        var item_detail = JSON.parse(localStorage.getItem("palabras")) || [];
        $.each(item_detail, function (index, obj) {
            if (key_id == data('palabras')) {
                item_detail.splice(index, 1);
                localStorage["palabras"] = JSON.stringify(item_detail);
                return false;
            }
        });
    }

    function EditComment(id) {

        $("#lblTitulo").text("Editar Descripción");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();

        $('#modal-content').load("/Ticket/UpdateDateTicket/" + id + "?_=" + Math.random());

    }

    function EditDetailComment(id) {
        $("#lblTitulo").text("Editar Comentario");

        $(".modal-dialog").removeClass("modal-sm");
        $(".modal-dialog").removeClass("modal-lg");
        $(".modal-dialog").addClass("modal-lg");

        $('#modal-content').empty();
        $('#modal-content').load("/DetailsTicket/UpdateDatesDetailsTicket/" + id + "?_=" + Math.random());

        //$("#divFrmLoadSummary").empty();
        @*if (parseInt(@Session["ID_ACCO"]) == 17 )
        *@//{
        //$("#divFrmLoadSummary").load("/DetailsTicket/UpdateDatesDetailsTicket/" + id + "?_=" + Math.random());
        //}
        //else {
        //$("#divFrmLoadSummary").load("/DetailsTicket/EditSummary/" + id + "?_=" + Math.random());
        //}
    }

    function winPopUpModal(title, contHtml, ancho, alto) {

        var altobkg = 0;
        var top = 0;
        altpan = $(window).height(); // devuelve la altura del viewport del navegador
        altobkg = $(document).height(); // devuelve la altura del documento HTML
        altbar = $(window).scrollTop(); // devuelve la posición vertical actual de la barra de scroll
        top = altbar + (altpan / 2);
        $("#divpopupmodal").prepend("<div id='bkg' class='backgroundcad' style='z-index: 999; display: visibility; height: " + altobkg + "px;'>" +
            "<div id='dlg' class='modalcad' style='z-index: 999; display: none; top: " + a_entero(top) + "px; width: " + a_entero(ancho) + "px; margin-left: -" + a_entero(ancho) / 2 + "px; height: " + a_entero(alto) + "px; margin-top: -" + a_entero(alto) / 2 + "px;'>" +
            "<div id='titulomodal' class='titlemodalcad'>" +
            "<div id='closebtnmodal' class='closebtnmodalcad' title='Cerrar'>X</div>" +
            "</div><div id='contenidomodal' class='contenidomodal'></div></div></div>");

        if ($('#bkg').css("visibility") == 'hidden') {
            document.getElementById('bkg').style.visibility = '';
            $("#bkg").hide();
        }
        if ($('#bkg').css("visibility") == 'hidden') {
            document.getElementById('dlg').style.visibility = '';
            $("#dlg").hide();
        }
        $("#bkg").fadeIn(300, "linear", function () {
            $("#dlg").show(200, "swing");
            $("#titulomodal").prepend(title)
            $("#contenidomodal").prepend('<div style="text-align:justify">' + contHtml + '</div>')
        });
        $("#closebtnmodal").click(function () {
            $("#dlg").hide('200', "swing", function () {
                $("#bkg").fadeOut("300");
            });
        });
    }

    function fxNewComment(obj) {
        ChangeX();

        $("#linkNC").addClass("activeNavDT");
        $("#divCausa").removeClass("divHide");
        if (@ViewBag.TicketProyecto == 1) {
            $("#subcategorizacionPry").removeClass("divHide");
            $("#divCtrlRemot").removeClass("divHide");
        } else {
            $("#subcategorizacionPry").addClass("divHide");
            $("#divCtrlRemot").addClass('divHide');
        }
        $("#ID_TYPE_DETA_TICK").val(1);

        $("#FEC_END_REAL").val('');
        //$("#divTypeTicket5").removeClass("divHide");
    }
    function fxSchedule(obj, eve) {
        ChangeX();
        $("#linkSCH").addClass("activeNavDT");
        $("#ID_TYPE_DETA_TICK").val(3);
        $("#ID_STAT").val(5);

        $("#fechaScheduled").removeClass("divHide");
        $("#divEsperaPorCliente").removeClass("divHide");
        $("#divTypeTicket3").removeClass("divHide");
        $("#fechaRealTermino").addClass("divHide");
        $("#divCausa").addClass("divHide");
        //Subcategorizacion de proyecto
        $("#subcategorizacionPry").addClass("divHide");
        $("#divCtrlRemot").addClass("divHide");
    }

    function fxUpdateStatus() {
        ChangeX();
        $("#linkUS").addClass("activeNavDT");
        $("#divCausa").addClass("divHide");
        //Subcategorizacion de proyecto
        $("#subcategorizacionPry").addClass("divHide");
        $("#divCtrlRemot").addClass("divHide");

        $("#ID_TYPE_DETA_TICK").val(3);

        $("#divStatus").removeClass("divHide");
        $("#divTypeTicket3").removeClass("divHide");

        if ($("#ID_STAT").val() == 5) {
            @*if (@Session["ID_ACCO"] == 60) {
                $("#ID_STAT").data("kendoComboBox").value(5);
            } else {*@
                $("#ID_STAT").data("kendoComboBox").value(5);
                /*}*/


                $("#fechaScheduled").removeClass("divHide");
                $("#divEsperaPorCliente").removeClass("divHide");
            }
        }

        function fxTransferTo() {
            ChangeX();
            $("#linkTT").addClass("activeNavDT");
            $("#divCausa").addClass("divHide");
            //Subcategorizacion de proyecto
            $("#subcategorizacionPry").addClass("divHide");
            $("#divCtrlRemot").addClass("divHide");

            $("#divTypeTicket2").removeClass("divHide");
            $("#ID_TYPE_DETA_TICK").val(2);
        }

        function fxTimer() {
            ChangeX();
            $("#linkTimer").addClass("activeNavDT");

            $("#ID_TYPE_DETA_TICK").val(9);
        }

        function fxOptions() {
            ChangeX();
            $("#linkOptions").addClass("activeNavDT");

            if (i_conf == 0) {
                $("#divDTOptions").css("height", 135);
                $("#divDTOptions").css("border", "1px solid #e2e2e2");
                i_conf = 1;
            }
            else {
                $("#divDTOptions").css("height", 0);
                $("#divDTOptions").css("border", "0px solid #e2e2e2");
                i_conf = 0;
            }
        }

        function ChangeX() {
            $("#linkSCH").removeClass("activeNavDT");
            $("#linkNC").removeClass("activeNavDT");
            $("#linkUS").removeClass("activeNavDT");
            $("#linkTT").removeClass("activeNavDT");
            $("#linkTimer").removeClass("activeNavDT");
            $("#linkOptions").removeClass("activeNavDT");
            $("#divTypeTicket2").addClass("divHide");
            $("#divTypeTicket3").addClass("divHide");
            $("#fechaScheduled").addClass("divHide");
            $("#divStatus").addClass("divHide");
            $("#divEsperaPorCliente").addClass("divHide");
            $("#divControlRemoto").addClass("divHide");
            //$("#divTypeTicket5").addClass("divHide");

            $("#ID_QUEU").data("kendoComboBox").value("");
        }

        function FcnSendSurvey(id) {

            swal({
                title: 'Warning',
                text: 'Are you sure to send survey',
                type: "info",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                cancelButtonText: "No",
                confirmButtonText: "Sí",
                closeOnConfirm: false
            }, function (dismiss) {
                if (dismiss) {
                    $.ajax({
                        url: "/Ticket/SendSurveyTicket/",
                        data: "ID_TICK=" + id + "&var=" + Math.random(),
                        type: "POST",
                        cache: false,
                        dataType: "text",
                        success: function (resp) {
                            if (resp == "OK") {


                                swal({
                                    title: 'Warning',
                                    type: 'success',
                                    text: 'Sent successfully',
                                    focusConfirm: false,
                                    confirmButtonText:
                                        'Continue',
                                    confirmButtonAriaLabel: 'Thumbs up, great!'

                                })
                            }
                            else if (resp == "EXISTE") {

                                //alert("The survey was sent");
                                swal({
                                    title: 'Warning',
                                    type: 'info',
                                    text: 'The survey was sent',
                                    focusConfirm: false,
                                    confirmButtonText:
                                        'Continue',
                                    confirmButtonAriaLabel: 'Thumbs up, great!'

                                })

                            }
                            else {
                                alert(Error);
                            }
                        }
                    });

                }

            })

        }

        function mover(IdTicketDetalle) {
            event.preventDefault();
            //$('html,body').animate({
            //    scrollTop: $("#" + IdTicketDetalle).offset().top
            //}, 1000);
            var elemento = document.getElementById("clipboard" + IdTicketDetalle);
            elemento.scrollIntoView({ behavior: "smooth", block: "end" });
            seleccionarTexto(IdTicketDetalle)
        }
        function seleccionarTexto(IdTicketDetalle) {
            var elemento = document.getElementById("clipboard" + IdTicketDetalle);
            var range = document.createRange();
            range.selectNodeContents(elemento);
            var seleccion = window.getSelection();
            seleccion.removeAllRanges();
            seleccion.addRange(range);
        }
        function GenerarCambio(id) {

            $("#lblTitulo").text("Gestión de Cambios");

            $(".modal-dialog").removeClass("modal-sm");
            $(".modal-dialog").removeClass("modal-lg");
            $(".modal-dialog").addClass("modal-lg");

            $('#modal-content').empty();
            @*if (@ViewBag.ID_ACCO == 60) {
                //  $('#modal-content').load("/ChangeRequest/RegistrarGestionCambioBNV/" + @ViewBag.ID_TICK);
            } else {*@
                $('#modal-content').load("/ChangeRequest/RegistrarGestionCambio/" + @ViewBag.ID_TICK);
                /*}*/


                @* $("#divGenerarCambio").empty();
                $("#divGenerarCambio").load("/ChangeRequest/RegistrarGestionCambio/" + @ViewBag.ID_TICK);*@
    }
            function IrCambio(id) {
                @*if (@ViewBag.ID_ACCO == 60) {
                    window.open("http://" + location.host + "/ResumenGestionCambioBNV/" + id)
                }
        else {*@
                    window.open("http://" + location.host + "/ChangeRequest/ResumenGestionCambio/" + id)
                    /* }*/
                }

                function OnPaste(e) {
                    var texto = e.html
                    if ((/^<img src="/).test(e.html)) {
                        toastr.warning("No se permiten imágenes en este campo.");
                        e.html = "";
                    }
                    if (texto.includes('<img data-imagetype=')) {
                        toastr.warning("No se permiten imágenes en este campo.");
                        e.html = "";
                    }
                }

                function Mensaje(msg, msnErr) {
                    if (msg == 'OK') {
                        toastr.success(msnErr);

                        //$("#id").submit();

                    }
                    else {
                        toastr.warning(msnErr);
                    }
                }

                function RegistrarTiempoAtencion() {

                    var urlRegistrarAtencion = "/DetailsTicket/RegistrarTiempoAtencion";

                    $.ajax({
                        url: urlRegistrarAtencion,
                        type: "POST",
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify({ idTicket: idTicket }), // Convertimos a JSON el objeto que enviamos
                        datatype: "json",
                        success: function (response) {
                            if (response.status === "OK") {

                                toastr.success('Registro del tiempo de atención correcto.');
                                location.reload();
                            } else {
                                toastr.error('No se pudo registrar el tiempo de atención.');
                            }
                        },
                        error: function () {
                            toastr.error('Ocurrió un error en la solicitud.');
                        }
                    });


                }

                function EnviarCorreoInforme(id) {
                    $("#lblTitulo").text("Enviar Correo");

                    $(".modal-dialog").removeClass("modal-sm");
                    $(".modal-dialog").removeClass("modal-lg");

                    // Limpiar el contenido previo
                    $('#modal-content').empty();

                    // Cargar el contenido del modal de manera dinámica
                    $('#modal-content').load("/DetailsTicket/EnviarCorreoResuelto/" + id + "?_=" + Math.random());

                    // Crear el modal con la nueva API de Bootstrap 5
                    var miModal = new bootstrap.Modal(document.getElementById('miModal'), {
                        backdrop: 'static',  // Impide cerrar el modal al hacer clic fuera de él
                        keyboard: false      // Impide cerrar el modal con la tecla Esc
                    });

                    // Mostrar el modal
                    miModal.show();
                }



</script>
